# DeFi å€Ÿè´·åˆçº¦

Day: Day 23
ID: 23
åŸæ–‡: https://www.notion.so/LendingPool-Contract-1de5720a23ef80b69930c481a98072df?source=copy_link
çŠ¶æ€: å®Œæˆ
è¯‘è€…: sun sun
éš¾åº¦ç­‰çº§: é«˜çº§

# å­¦ä¹ å†…å®¹

æ¬¢è¿å›åˆ° 30 å¤© Solidity â€”â€” æ¯å¤©è§£é”æ™ºèƒ½åˆçº¦çš„ä¸€é¡¹æ–°è¶…èƒ½åŠ›ã€‚

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ å·²ç»æ„å»ºäº†å¯ä»¥å‘é€å’Œæ¥æ”¶ ETH çš„åˆçº¦ï¼Œç”¨è®¿é—®æ§åˆ¶ä¿æŠ¤å®ƒä»¬ï¼Œç”šè‡³æ¶‰è¶³äº† NFTã€‚ä½†ä»Šå¤©å‘¢ï¼Ÿ

**ä»Šå¤©ï¼Œæˆ‘ä»¬æ„å»ºä¸€ä¸ªé“¶è¡Œã€‚**

ä¸æ˜¯é‚£ç§éœ€è¦æ’é•¿é˜Ÿã€å¡«å†™ç¹çæ–‡ä»¶å’Œéšè—è´¹ç”¨çš„ç±»å‹ã€‚

ä¹Ÿä¸æ˜¯é‚£ç§ä¸‹åˆäº”ç‚¹å°±å…³é—¨çš„é‚£ç§ã€‚

æˆ‘ä»¬è°ˆè®ºçš„æ˜¯ DeFiâ€”â€”å³å»ä¸­å¿ƒåŒ–é‡‘èçš„ç¼©å†™ã€‚

è¿™ä¸ä»…ä»…æ˜¯ä¸€ä¸ªæµè¡Œè¯æ±‡ã€‚DeFi æ˜¯åŒºå—é“¾é¢†åŸŸæœ€å…·å˜é©æ€§çš„è¿åŠ¨ä¹‹ä¸€ã€‚å®ƒå…³ä¹é‡å»ºæ•´ä¸ªé‡‘èä½“ç³»â€”â€”å€Ÿè´·ã€å‚¨è“„ã€äº¤æ˜“â€”â€”ä½†è¿™ä¸€åˆ‡éƒ½ä¸éœ€è¦ä¸­å¿ƒåŒ–æœºæ„çš„å‚ä¸ã€‚

æƒ³è±¡ä¸€ä¸‹ï¼š

æ²¡æœ‰é“¶è¡Œå†»ç»“ä½ çš„è´¦æˆ·ã€‚

æ²¡æœ‰è´·æ¬¾å‘˜è¯„åˆ¤ä½ çš„ä¿¡ç”¨ã€‚

ä»…ä»£ç â€”â€”å¼€æ”¾ã€é€æ˜ã€ä¸å¯é˜»æŒ¡çš„ä»£ç â€”â€”ä»»ä½•äººéƒ½å¯ä»¥ä¸ä¹‹äº¤äº’ã€‚

è¿™å°±æ˜¯ DeFi å¦‚æ­¤å¼ºå¤§çš„åŸå› ã€‚ä½ å°†ä¼ ç»Ÿé‡‘èçš„è§„åˆ™è½¬åŒ–ä¸ºæ™ºèƒ½åˆçº¦é€»è¾‘ï¼Œç„¶åè®©åŒºå—é“¾æ¥å®Œæˆå‰©ä¸‹çš„å·¥ä½œã€‚

è€Œè¿™é‡Œçš„ç¥å¥‡ä¹‹å¤„åœ¨äºï¼šä¸€æ—¦éƒ¨ç½²ï¼Œåˆçº¦å°±ä¸å…³å¿ƒä½ æ˜¯è°ã€‚

å¦‚æœæ•°å­—å¯¹å¾—ä¸Šâ€”â€”ä½ å¯ä»¥å€Ÿè´·ï¼Œä½ å¯ä»¥èµšå–åˆ©æ¯ã€‚

æˆ‘ä»¬ä»Šå¤©è¦æ„å»ºä»€ä¹ˆï¼Ÿ

æˆ‘ä»¬æ­£åœ¨åˆ›å»ºä¸€ä¸ªç®€å•è€Œå¼ºå¤§çš„å€Ÿè´·æ± ã€‚

ç±»ä¼¼äº Aave æˆ– Compound ç­‰å¹³å°æä¾›çš„è¿·ä½ ç‰ˆæœ¬â€”â€”ä½†æ›´å®¹æ˜“ç†è§£ã€‚

Â ä½ å°†å­¦åˆ°ï¼š

 æ¥å—ç”¨æˆ·å­˜æ¬¾ ETH ğŸ’°

è®©ä»–ä»¬é”å®šæŠµæŠ¼å“ä»¥è§£é”å€Ÿæ¬¾ ğŸ›¡ï¸

éšæ—¶é—´æ”¶å–åˆ©æ¯ ğŸ“ˆ

å…è®¸ç”¨æˆ·å¿è¿˜è´·æ¬¾å¹¶æå–èµ„é‡‘ âœ…

è¿™æ˜¯ä½ ç¬¬ä¸€æ¬¡äº²èº«ä½“éªŒ DeFi æœºåˆ¶â€”â€”ç›¸ä¿¡æˆ‘ï¼Œå®ƒå°†æ°¸è¿œæ”¹å˜ä½ å¯¹æ™ºèƒ½åˆçº¦çš„çœ‹æ³•ã€‚

è®©æˆ‘ä»¬å¼€å§‹å§ã€‚

### **ğŸ” å¿«é€Ÿäº†è§£æˆ‘ä»¬æ­£åœ¨æ„å»ºçš„å†…å®¹**

SimpleLending åˆçº¦æ˜¯ä½ é“¾ä¸Šç¬¬ä¸€ä¸ª DeFi é“¶è¡Œã€‚

å®ƒå…è®¸ç”¨æˆ·ï¼š

- å°† ETH å­˜å…¥æ± ä¸­
- é”å®šæŠµæŠ¼å“ä»¥è·å–è´·æ¬¾
- åŸºäºè¯¥æŠµæŠ¼å“å€Ÿå…¥ ETH
- ç”¨åˆ©æ¯å¿è¿˜è´·æ¬¾
- å®Œæˆåå†æå–èµ„é‡‘

æˆ‘ä»¬ä¿æŒå…¶ç®€æ´â€”â€”æ²¡æœ‰ ERC20ï¼Œæ²¡æœ‰å¤–éƒ¨ä»·æ ¼ä¿¡æ¯â€”â€”åªæ˜¯çº¯ç²¹çš„åŸºäº ETH çš„å€Ÿè´·é€»è¾‘ï¼Œå¸®åŠ©ä½ ç†è§£ DeFi çš„æ ¸å¿ƒè¿ä½œæ–¹å¼ã€‚ç°åœ¨è®©æˆ‘ä»¬çœ‹çœ‹å®Œæ•´ä»£ç  ğŸ‘‡

**ğŸ§¾ å®Œæ•´åˆçº¦ï¼šSimpleLending.sol**

```solidity
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.0;

/**
 * @title SimpleLending
 * @dev A basic DeFi lending and borrowing platform
 */
contract SimpleLending {
    // Token balances for each user
    mapping(address => uint256) public depositBalances;

    // Borrowed amounts for each user
    mapping(address => uint256) public borrowBalances;

    // Collateral provided by each user
    mapping(address => uint256) public collateralBalances;

    // Interest rate in basis points (1/100 of a percent)
    // 500 basis points = 5% interest
    uint256 public interestRateBasisPoints = 500;

    // Collateral factor in basis points (e.g., 7500 = 75%)
    // Determines how much you can borrow against your collateral
    uint256 public collateralFactorBasisPoints = 7500;

    // Timestamp of last interest accrual
    mapping(address => uint256) public lastInterestAccrualTimestamp;

    // Events
    event Deposit(address indexed user, uint256 amount);
    event Withdraw(address indexed user, uint256 amount);
    event Borrow(address indexed user, uint256 amount);
    event Repay(address indexed user, uint256 amount);
    event CollateralDeposited(address indexed user, uint256 amount);
    event CollateralWithdrawn(address indexed user, uint256 amount);

    function deposit() external payable {
        require(msg.value > 0, "Must deposit a positive amount");
        depositBalances[msg.sender] += msg.value;
        emit Deposit(msg.sender, msg.value);
    }

    function withdraw(uint256 amount) external {
        require(amount > 0, "Must withdraw a positive amount");
        require(depositBalances[msg.sender] >= amount, "Insufficient balance");
        depositBalances[msg.sender] -= amount;
        payable(msg.sender).transfer(amount);
        emit Withdraw(msg.sender, amount);
    }

    function depositCollateral() external payable {
        require(msg.value > 0, "Must deposit a positive amount as collateral");
        collateralBalances[msg.sender] += msg.value;
        emit CollateralDeposited(msg.sender, msg.value);
    }

    function withdrawCollateral(uint256 amount) external {
        require(amount > 0, "Must withdraw a positive amount");
        require(collateralBalances[msg.sender] >= amount, "Insufficient collateral");

        uint256 borrowedAmount = calculateInterestAccrued(msg.sender);
        uint256 requiredCollateral = (borrowedAmount * 10000) / collateralFactorBasisPoints;

        require(
            collateralBalances[msg.sender] - amount >= requiredCollateral,
            "Withdrawal would break collateral ratio"
        );

        collateralBalances[msg.sender] -= amount;
        payable(msg.sender).transfer(amount);
        emit CollateralWithdrawn(msg.sender, amount);
    }

    function borrow(uint256 amount) external {
        require(amount > 0, "Must borrow a positive amount");
        require(address(this).balance >= amount, "Not enough liquidity in the pool");

        uint256 maxBorrowAmount = (collateralBalances[msg.sender] * collateralFactorBasisPoints) / 10000;
        uint256 currentDebt = calculateInterestAccrued(msg.sender);

        require(currentDebt + amount <= maxBorrowAmount, "Exceeds allowed borrow amount");

        borrowBalances[msg.sender] = currentDebt + amount;
        lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

        payable(msg.sender).transfer(amount);
        emit Borrow(msg.sender, amount);
    }

    function repay() external payable {
        require(msg.value > 0, "Must repay a positive amount");

        uint256 currentDebt = calculateInterestAccrued(msg.sender);
        require(currentDebt > 0, "No debt to repay");

        uint256 amountToRepay = msg.value;
        if (amountToRepay > currentDebt) {
            amountToRepay = currentDebt;
            payable(msg.sender).transfer(msg.value - currentDebt);
        }

        borrowBalances[msg.sender] = currentDebt - amountToRepay;
        lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

        emit Repay(msg.sender, amountToRepay);
    }

    function calculateInterestAccrued(address user) public view returns (uint256) {
        if (borrowBalances[user] == 0) {
            return 0;
        }

        uint256 timeElapsed = block.timestamp - lastInterestAccrualTimestamp[user];
        uint256 interest = (borrowBalances[user] * interestRateBasisPoints * timeElapsed) / (10000 * 365 days);

        return borrowBalances[user] + interest;
    }

    function getMaxBorrowAmount(address user) external view returns (uint256) {
        return (collateralBalances[user] * collateralFactorBasisPoints) / 10000;
    }

    function getTotalLiquidity() external view returns (uint256) {
        return address(this).balance;
    }
}

```

### 

# 1.äº§å“éœ€æ±‚ä¹¦

### a.ç”¨æˆ·æµç¨‹

```mermaid
graph TD
DeFiå€Ÿè´·ç³»ç»Ÿ -->ç”¨æˆ·æ“ä½œ{ç”¨æˆ·æ“ä½œé€‰æ‹©}
 ç”¨æˆ·æ“ä½œ -->å­˜æ¬¾[å­˜å…¥ETH] --> æ¥æ”¶eth --> æ›´æ–°ä½™é¢
  ç”¨æˆ·æ“ä½œ -->ææ¬¾[å–å‡ºå­˜å…¥çš„eth] -->æ£€æŸ¥ç”¨æˆ·ä½™é¢{ç”¨æˆ·ä½™é¢>=å–æ¬¾é‡‘é¢} -->æ›´æ–°ä½™é¢-->å‘é€eth
	ç”¨æˆ·æ“ä½œ -->åˆ©æ¯è®¡ç®—-->æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å€Ÿæ¬¾{æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å€Ÿæ¬¾}
	æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å€Ÿæ¬¾-->å¦-->è¿”å›
	æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰å€Ÿæ¬¾-->æ˜¯-->è®¡ç®—è·ä¸Šæ¬¡è®¡ç®—åˆ©æ¯çš„æ—¶é—´-->è®¡ç®—åˆ©æ¯-->è¿”å›æ€»å€ºåŠ¡
	ç”¨æˆ·æ“ä½œ -->é”å®šeth-->æ£€æŸ¥ç”¨æˆ·å­˜é¢-->å¢åŠ ç”¨æˆ·æŠµæŠ¼å“ä½™é¢
 ç”¨æˆ·æ“ä½œ -->æŠµæŠ¼å“æå–[å–å‡ºæŠµæŠ¼ç‰©]-->æ£€æŸ¥ç”¨æˆ·é‡‘é¢-->æ£€æŸ¥æŠµæŠ¼å“ä½™é¢{æ£€æŸ¥ç”¨æˆ·ææ¬¾åä»æœ‰æŠµæŠ¼å“}-->æ›´æ–°è®°å½•-->å‘æ”¾eth

  ç”¨æˆ·æ“ä½œ-->å€Ÿæ¬¾[å€Ÿå…¥eth]-->æ£€æŸ¥æ± ä¸­æµåŠ¨æ€§{æ± å­æµåŠ¨æ€§>è¦å€Ÿçš„}-->è®¡ç®—æœ€å¤§å¯å€Ÿé‡‘é¢-->åˆ©æ¯è®¡ç®—-->æ£€æŸ¥å€Ÿæ¬¾äººèµ„æ ¼{æ€»å€ºåŠ¡<=æœ€å¤§å¯å€Ÿé‡‘é¢}-->æ›´æ–°å€ºåŠ¡å’Œæ—¶é—´-->è½¬è´¦eth
  ç”¨æˆ·æ“ä½œ -->è¿˜æ¬¾-->æ£€æŸ¥å‘é€é‡‘é¢{msg.value > 0}-->åˆ©æ¯è®¡ç®—-->æ£€æŸ¥ç”¨æˆ·å€ºåŠ¡{å€ºåŠ¡>0}-->è®°å½•å¿è¿˜é‡‘é¢-->æ£€æŸ¥é‡‘é¢{å‘é€çš„eth>å€ºåŠ¡}-->æ˜¯çš„-->é€€è¿˜å¤šä½™éƒ¨åˆ†-->æ›´æ–°è´·æ¬¾è®°å½•
  æ£€æŸ¥é‡‘é¢{å‘é€çš„eth>å€ºåŠ¡}-->å¦çš„-->æ›´æ–°è´·æ¬¾è®°å½•

```

### b.æ•°æ®åº“

| Contract | Type | Bases |
| --- | --- | --- |
| SimpleLending | Implementation |  |

| â”” Function Name | Visibility | Mutability |
| --- | --- | --- |
| deposit | external | payable |
| withdraw | external | ğŸ›‘ |
| depositCollateral | external | payable |
| withdrawCollateral | external | ğŸ›‘ |
| borrow | external | ğŸ›‘ |
| repay | external | payable |
| calculateInterestAccrued | public | view |
| getMaxBorrowAmount | external | view |
| getTotalLiquidity | external | view |

# 2.ç»†èŠ‚è§£è¯´

### **ğŸ§¾ åˆåŒå£°æ˜**

```solidity
contract SimpleLending {

```

æˆ‘ä»¬å‘½åæˆ‘ä»¬çš„åˆçº¦ SimpleLendingï¼Œå› ä¸ºï¼Œå—¯â€¦â€¦å®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å€Ÿè´·ç³»ç»Ÿã€‚è¿™æ˜¯æˆ‘ä»¬ DeFi é“¶è¡Œçš„åŸºç¡€ã€‚

### **ğŸ§  åˆçº¦çš„å¤§è„‘â€”â€”æ˜ å°„**

åœ¨ä»»ä½•é“¶è¡Œç³»ç»Ÿâ€”â€”æ— è®ºæ˜¯ä½ æ‰€åœ¨åœ°çš„åˆ†è¡Œè¿˜æ˜¯ DeFi æ™ºèƒ½åˆçº¦â€”â€”éƒ½éœ€è¦ä¸€ç§æ–¹æ³•æ¥è®°ä½è°æ‹¥æœ‰ä»€ä¹ˆã€‚

è¿™æ­£æ˜¯æˆ‘ä»¬åœ¨åšçš„å·¥ä½œã€‚

è¿™ä¸€éƒ¨åˆ†æ˜¯æˆ‘ä»¬å€Ÿè´·æ± çš„å¤§è„‘ã€‚è¿™äº›æ˜ å°„æ˜¯æˆ‘ä»¬è¿½è¸ªå­˜æ¬¾ã€å€ºåŠ¡ã€æŠµæŠ¼å“å’Œåˆ©æ¯çš„æ–¹å¼â€”â€”å°±åƒä¸€ä¸ªæ•°å­—è´¦æœ¬ï¼Œåœ¨é“¾ä¸Šä¿æŒä¸€åˆ‡äº•ç„¶æœ‰åºã€‚

è®©æˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªåˆçº¦ä¸­çš„å››ä¸ªå…³é”®æ˜ å°„ï¼š

```solidity
mapping(address => uint256) public depositBalances;
mapping(address => uint256) public borrowBalances;
mapping(address => uint256) public collateralBalances;
mapping(address => uint256) public lastInterestAccrualTimestamp;

```

### **depositBalances â€“æ‚¨çš„æ•°å­—ä¿é™©åº“**

è¿™ä¸ªæ˜ å°„è®°å½•ç”¨æˆ·å­˜å…¥å€Ÿè´·æ± çš„ ETH æ•°é‡ã€‚

æŠŠå®ƒçœ‹ä½œåˆçº¦å†…éƒ¨çš„ä¸€ä¸ªä¸ªäººä¿é™©åº“ã€‚å½“ç”¨æˆ·è°ƒç”¨ deposit()å‡½æ•°æ—¶ï¼Œä»–ä»¬çš„ ETH ä¼šè¢«å­˜å‚¨åœ¨åˆçº¦ä¸­ï¼Œè¿™ä¸ªæ˜ å°„ä¼šæ›´æ–°ä»¥åæ˜ ä»–ä»¬æ·»åŠ äº†å¤šå°‘ã€‚

> ğŸ“¦ å®ƒå°±åƒä½ çš„æ´»æœŸè´¦æˆ·ä½™é¢ä¸€æ ·â€”â€”é™¤éä¸è´·æ¬¾æŒ‚é’©ï¼Œå¦åˆ™å§‹ç»ˆå¯ä»¥è®¿é—®ã€‚
> 

### **borrowBalances â€“ ä½ çš„è´·æ¬¾è´¦ç°¿**

è¿™ä¸ªæ˜ å°„æ˜¾ç¤ºäº†ç”¨æˆ·ä»æ± ä¸­å€Ÿäº†å¤šå°‘ ETHã€‚

å½“ä½ ä½¿ç”¨ borrow()å‡½æ•°å€Ÿæ¬¾æ—¶ï¼ŒETH ä¼šç¦»å¼€åˆçº¦å¹¶è¿›å…¥ä½ çš„é’±åŒ…ã€‚åŒæ—¶ï¼Œè¿™ä¸ªæ˜ å°„ä¼šæ›´æ–°ä»¥ç²¾ç¡®è·Ÿè¸ªä½ æ¬ å¤šå°‘å€ºåŠ¡ã€‚

æˆ‘ä»¬ä¹Ÿä½¿ç”¨è¿™ä¸ªå€¼ï¼ˆä»¥åŠåˆ©æ¯ï¼‰æ¥ç¡®å®šä½ æ˜¯å¦å¯ä»¥æå–ä½ çš„æŠµæŠ¼å“æˆ–å€Ÿæ›´å¤šã€‚

> ğŸ§¾ è¿™æ˜¯ä½ çš„è´·æ¬¾è¿½è¸ªå™¨â€”â€”é‚£ä¸ªæ˜¾ç¤ºâ€œè¿™æ˜¯ä½ æ¬ æ¬¾â€çš„æ•°å­—ã€‚
> 

### **collateralBalances â€“ å®‰å…¨ç½‘**

åœ¨å»ä¸­å¿ƒåŒ–é‡‘èï¼ˆDeFiï¼‰ä¸­ï¼Œå€Ÿè´·ä¸æ˜¯åŸºäºä¿¡ä»»ï¼Œè€Œæ˜¯åŸºäºæ•°å­¦ã€‚

è¦å€Ÿæ¬¾ï¼Œä½ éœ€è¦æŠµæŠ¼èµ„äº§ã€‚è¿™ä¸ªæ˜ å°„è®°å½•äº†æ¯ä¸ªç”¨æˆ·æä¾›çš„ä½œä¸ºæŠµæŠ¼çš„ ETH æ•°é‡ã€‚

å½“ä½ è°ƒç”¨ depositCollateral()æ—¶ï¼ŒETH ä¼šç•™åœ¨åˆçº¦ä¸­ï¼Œä½†ä½ çš„ collateralBalances æ¡ç›®ä¼šå¢åŠ ã€‚

å½“ä½ å°è¯•å€Ÿæ¬¾æˆ–æå–æŠµæŠ¼èµ„äº§æ—¶ï¼Œåˆçº¦ä¼šä½¿ç”¨è¿™ä¸ªæ˜ å°„æ¥æ£€æŸ¥ä½ çš„å¤´å¯¸æ˜¯å¦ä»ç„¶å®‰å…¨ã€‚

> ğŸ” æƒ³è±¡ä¸€ä¸‹è¿™å°±åƒä½ çš„æŠ¼é‡‘â€”â€”å®ƒå­˜åœ¨æ˜¯ä¸ºäº†åœ¨ä½ ä¸å±¥è¡Œä¹‰åŠ¡æ—¶ä¿æŠ¤ç³»ç»Ÿã€‚
> 

### **lastInterestAccrualTimestamp â€“ è®¡æ—¶å‘˜**

æˆ‘ä»¬çš„ç³»ç»Ÿä¸­çš„åˆ©æ¯ä¸ä¼šæ¯ç§’è‡ªåŠ¨ç´¯ç§¯â€”â€”é‚£ä¼šéå¸¸è€—è´¹ gasã€‚

ç›¸åï¼Œæˆ‘ä»¬è®°å½•æ¯ä¸ªç”¨æˆ·ä¸Šæ¬¡è®¡ç®—åˆ©æ¯çš„æ—¶é—´ã€‚ç„¶åï¼Œæ¯å½“ç”¨æˆ·ä¸ç³»ç»Ÿäº¤äº’ï¼ˆå€Ÿæ¬¾ã€è¿˜æ¬¾ç­‰ï¼‰æ—¶ï¼Œæˆ‘ä»¬ä¼šæ£€æŸ¥ç»è¿‡çš„æ—¶é—´ï¼Œå¹¶è®¡ç®—ä»é‚£æ—¶èµ·ç´¯ç§¯äº†å¤šå°‘åˆ©æ¯ã€‚

è¿™ä½¿æˆ‘ä»¬èƒ½å¤Ÿåœ¨ä¸æ¯å—é“¾æ”¯ä»˜åˆ©æ¯çš„æƒ…å†µä¸‹æ¨¡æ‹Ÿè¿ç»­çš„åˆ©æ¯ã€‚

> ğŸ§® è¿™å°±åƒä¸€ä¸ªæ—¶é—´æˆ³æ”¶æ®ï¼šâ€œä¸Šæ¬¡æˆ‘ä»¬æ£€æŸ¥æ—¶ï¼Œè¿™ä½ç”¨æˆ·æ¬ æ¬¾ Xã€‚ç°åœ¨è®©æˆ‘ä»¬æ ¹æ®ç»è¿‡çš„æ—¶é—´æ¥æ›´æ–°ã€‚â€
> 

### **ğŸ’° å€Ÿè´·é€»è¾‘â€”â€”è®¾å®šé‡‘èè§„åˆ™**

æ¯ä¸ªå€Ÿè´·å¹³å°â€”â€”æ— è®ºæ˜¯ DeFi åè®®è¿˜æ˜¯å½“åœ°é“¶è¡Œâ€”â€”éƒ½éµå¾ªå‡ æ¡å…³é”®çš„é‡‘èè§„åˆ™ã€‚

åœ¨æˆ‘ä»¬çš„æ™ºèƒ½åˆçº¦ä¸­ï¼Œè¿™äº›è§„åˆ™è¢«åµŒå…¥åˆ°ä¸¤ä¸ªç®€å•çš„å˜é‡ä¸­ï¼š

```solidity
uint256 public interestRateBasisPoints = 500;         // 5% annual interest rate
uint256 public collateralFactorBasisPoints = 7500;    // 75% loan-to-value (LTV)

```

è®©æˆ‘ä»¬é€ä¸€è§£æè¿™äº›å˜é‡çš„å«ä¹‰åŠå…¶é‡è¦æ€§ã€‚

### **ğŸ§¾ interestRateBasisPoints â€“ åè®®å¦‚ä½•èµšå–æ”¶ç›Š**

è¿™æ˜¯å€Ÿæ¬¾äººæ¯å¹´éœ€æ”¯ä»˜çš„è´·æ¬¾åˆ©ç‡ã€‚

ä½†æˆ‘ä»¬ç”¨ 500 è¡¨ç¤º 5%ï¼Œè€Œä¸æ˜¯å†™ 5ï¼Œå› ä¸ºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯åŸºç‚¹ã€‚

> ğŸ”¢ åŸºç‚¹åœ¨é‡‘èä¸­ç”¨äºç²¾ç¡®è¡¨è¾¾ç™¾åˆ†æ¯”ï¼Œå°¤å…¶æ˜¯åœ¨å¤„ç†åˆ†æ•°åˆ©ç‡æ—¶ã€‚1 ä¸ªåŸºç‚¹æ˜¯ 0.01%ï¼Œæ‰€ä»¥ 500 ä¸ªåŸºç‚¹æ˜¯ 5%
> 

è¿™æ„å‘³ç€ï¼š

å¦‚æœä¸€ä¸ªç”¨æˆ·å€Ÿå…¥ 1 ETHï¼Œä¸€å¹´åï¼ˆå‡è®¾ä»–ä»¬æ²¡æœ‰æå‰è¿˜æ¬¾ï¼‰å°†éœ€è¦å¿è¿˜ 1.05 ETHã€‚

é€šè¿‡ä½¿ç”¨åŸºç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥é¿å…æµ®ç‚¹æ•°è¿ç®—ï¼ˆSolidity ä¸æ”¯æŒæµ®ç‚¹æ•°è¿ç®—ï¼‰ï¼Œå¹¶ä¿æŒæé«˜çš„ç²¾ç¡®åº¦ã€‚

### **ğŸ›¡ï¸ collateralFactorBasisPoints â€“ åè®®å¦‚ä½•ä¿æŒå®‰å…¨**

è¯¥å˜é‡å†³å®šäº†æ ¹æ®æŠµæŠ¼å“ä»·å€¼å¯ä»¥å€Ÿå¤šå°‘ã€‚

åœ¨æˆ‘ä»¬è¿™é‡Œï¼š

7500 ä¸ªåŸºç‚¹ = 75%

è¿™æ„å‘³ç€ç”¨æˆ·åªèƒ½å€Ÿå…¥ä»–ä»¬ä½œä¸ºæŠµæŠ¼é”å®š ETH çš„ 75%

å‡è®¾ä½ å°† 2 ETH ä½œä¸ºæŠµæŠ¼ï¼š

2 ETH çš„ 75% = 1.5 ETH

è¿™å°±æ˜¯ä½ è¢«å…è®¸å€Ÿå…¥çš„æœ€å¤§é‡‘é¢

ä¸ºä»€ä¹ˆä¸æ˜¯ 100%ï¼Ÿ

å› ä¸ºå­˜åœ¨ä»·æ ¼æ³¢åŠ¨ã€‚ETH æ˜å¤©å¯èƒ½ä¼šè´¬å€¼ã€‚æ‰€ä»¥æˆ‘ä»¬æ€»æ˜¯å¸Œæœ›å€Ÿæ¬¾äººç•™ä¸‹ä¸€å±‚å®‰å…¨å«â€”â€”è¿™å°±æ˜¯æŠµæŠ¼ç‡å¼ºåˆ¶æ‰§è¡Œçš„æœºåˆ¶ã€‚

> ğŸ§  ç°å®ä¸­çš„æ¯”å–»ï¼šè¿™å°±åƒé“¶è¡Œè¯´â€œæˆ‘ä»¬å¯ä»¥ç”¨ä½ çš„è½¦ä½œä¸ºæŠµæŠ¼è´·æ¬¾â€”â€”ä½†åªèƒ½æŒ‰å…¶å½“å‰ä»·å€¼çš„ 75%æ¥è´·ã€‚â€
> 

è¿™æœ‰åŠ©äºåè®®é¿å…äºæŸï¼Œå¹¶ç¡®ä¿å€Ÿæ¬¾äººå§‹ç»ˆæœ‰è¶³å¤Ÿçš„æŠµæŠ¼ç‰©æ¥æ”¯æŒä»–ä»¬çš„è´·æ¬¾ã€‚

### **ğŸ“£ äº‹ä»¶ â€“ æ´»åŠ¨å¹¿æ’­**

ä»¥ä¸‹æ˜¯æˆ‘ä»¬åœ¨ DeFi é“¶è¡Œä¸­ä½¿ç”¨çš„äº‹ä»¶ï¼š

```solidity
event Deposit(address indexed user, uint256 amount);
event Withdraw(address indexed user, uint256 amount);
event Borrow(address indexed user, uint256 amount);
event Repay(address indexed user, uint256 amount);
event CollateralDeposited(address indexed user, uint256 amount);
event CollateralWithdrawn(address indexed user, uint256 amount);

```

è®©æˆ‘ä»¬æ¥åˆ†è§£å®ƒä»¬ï¼š

### **ğŸ’¸ Deposit**

å½“ç”¨æˆ·å‘å€Ÿè´·æ± æ·»åŠ  ETH æ—¶å‘å‡ºã€‚

> è¿™å°±åƒåœ¨è¯´ï¼šâ€œç”¨æˆ· X åˆšåˆšå­˜å…¥äº† Y ETHâ€”â€”æ›´æ–°ä»–ä»¬çš„ä½™é¢å¹¶åœ¨ä»ªè¡¨æ¿ä¸Šæ˜¾ç¤ºï¼â€
> 

### **ğŸ§ Withdraw**

å½“ç”¨æˆ·ä»ä»–ä»¬çš„å­˜æ¬¾ä½™é¢ä¸­å–å‡º ETH æ—¶è§¦å‘ã€‚

> ç”¨äºåœ¨ UI ä¸­åæ˜ ææ¬¾æƒ…å†µï¼Œå¹¶è®°å½•åˆçº¦çš„ ETH ä½™é¢å·²å˜æ›´ã€‚
> 

### **ğŸ§¾ Borrow**

å½“ç”¨æˆ·æˆåŠŸå€Ÿæ¬¾æ—¶è§¦å‘ã€‚

> æ‚¨çš„åº”ç”¨å¯ä»¥æ˜¾ç¤ºï¼šâ€œæ­å–œï¼æ‚¨åˆšåˆšä»æ± ä¸­å€Ÿäº† 0.75 ETHã€‚â€
> 

### **ğŸ’³ Repay**

å½“ç”¨æˆ·å‘é€ ETH ä»¥å¿è¿˜è´·æ¬¾æ—¶è§¦å‘ã€‚

> å¯¹æ›´æ–°ç”¨æˆ·çš„è´·æ¬¾ä½™é¢å’Œè®¡ç®—å‰©ä½™å€ºåŠ¡éå¸¸é‡è¦ã€‚
> 

### **ğŸ›¡ï¸ CollateralDeposited**

å½“ç”¨æˆ·å°† ETH é”å®šä½œä¸ºæŠµæŠ¼å“æ—¶å‘å‡ºã€‚

> å‰ç«¯åº”ç”¨å¯ä»¥ä½¿ç”¨æ­¤åŠŸèƒ½æ˜¾ç¤ºï¼šâ€œæ‚¨ç°åœ¨æœ‰èµ„æ ¼å€Ÿå…¥æœ€å¤š X ETHã€‚â€
> 

### **ğŸ”“ CollateralWithdrawn**

å½“ç”¨æˆ·å®‰å…¨æå–å…¶æŠµæŠ¼å“æ—¶å‘ç”Ÿï¼ˆåœ¨è¿˜æ¬¾åæˆ–ä¿æŒå¥åº·çš„è´·æ¬¾ä»·å€¼æ¯”ä¹‹åï¼‰ã€‚

> è¿™æ˜¯ä¸€ä¸ªæœ‰ç”¨çš„è§¦å‘å™¨ï¼Œç”¨äºå¯è§†åŒ–å‰©ä½™çš„æŠµæŠ¼å“æ•°é‡ã€‚
> 

### **ğŸ”§ Functions â€”â€”é©±åŠ¨ DeFi å¼•æ“**

æˆ‘ä»¬è‡³ä»Šæ‰€æ„å»ºçš„ä¸€åˆ‡â€”â€”å˜é‡ã€æ˜ å°„ã€å‚æ•°ã€äº‹ä»¶â€”â€”å®ƒä»¬éƒ½åªæ˜¯åŸºç¡€ã€‚

çœŸæ­£çš„é­”æ³•å‘ç”Ÿåœ¨ç”¨æˆ·ä¸åˆçº¦äº¤äº’æ—¶ã€‚

è¿™äº›åŠŸèƒ½æ˜¯ç”¨æˆ·åœ¨æ‚¨çš„ DeFi é“¶è¡Œä¸­æ‰§è¡Œæ“ä½œçš„æ–¹å¼ï¼šå­˜æ¬¾ ETHã€å€Ÿæ¬¾ã€å¿è¿˜è´·æ¬¾å’Œç®¡ç†æŠµæŠ¼å“ã€‚è¿™å°±æ˜¯åˆçº¦å˜å¾—äº’åŠ¨çš„åœ°æ–¹ã€‚

è®©æˆ‘ä»¬ä»è¯¥æµç¨‹ä¸­çš„ç¬¬ä¸€ä¸ªåŠŸèƒ½â€”â€”å­˜æ¬¾å¼€å§‹ã€‚

## **ğŸ¦ deposit() â€“ å‘æ± ä¸­æ·»åŠ  ETH**

```solidity
function deposit() external payable {
    require(msg.value > 0, "Must deposit a positive amount");

    depositBalances[msg.sender] += msg.value;

    emit Deposit(msg.sender, msg.value);
}

```

è¿™ä¸ªå‡½æ•°æ˜¯ç”¨æˆ·å‘å€Ÿè´·æ± ä¸­æ·»åŠ  ETH çš„æ–¹å¼â€”â€”ç®€å•è‡³æã€‚

è¿™æ˜¯é€æ­¥æ“ä½œæ–¹æ³•ï¼š

### **1. msg.valueâ€“ æ¥æ”¶ ETH**

æ¯å½“æœ‰äººå‘æ™ºèƒ½åˆçº¦å‘é€ ETH æ—¶ï¼Œé‡‘é¢ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªç§°ä¸º msg.value çš„ç‰¹æ®Šå˜é‡ä¸­ã€‚

æ‰€ä»¥å¦‚æœæˆ‘è°ƒç”¨ deposit()å¹¶é™„åŠ  1 ETHï¼Œmsg.value å°†æ˜¯ 1 ä»¥å¤ªå¸ã€‚

æˆ‘ä»¬é¦–å…ˆæ£€æŸ¥ï¼š

```solidity
require(msg.value > 0, "Must deposit a positive amount");

```

è¿™ä¸€è¡Œé˜²æ­¢äººä»¬åœ¨ä¸å‘é€ä»»ä½• ETH çš„æƒ…å†µä¸‹æ„å¤–è°ƒç”¨è¯¥å‡½æ•°ã€‚æ²¡æœ‰å…è´¹æ­ä¾¿è½¦ï¼

### **2. æ›´æ–°ä½™é¢**

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ›´æ–°è·Ÿè¸ªæ¯ä¸ªç”¨æˆ·å­˜æ¬¾çš„æ˜ å°„ï¼š

```solidity
depositBalances[msg.sender] += msg.value;

```

è¿™é‡Œï¼Œmsg.sender æ˜¯è°ƒç”¨å‡½æ•°çš„äººâ€”â€”å³å­˜æ¬¾äººã€‚

æˆ‘ä»¬çš„æ„æ€æ˜¯ï¼šâ€œå°†ä»–ä»¬ä¹‹å‰æ‹¥æœ‰çš„é‡‘é¢ï¼ŒåŠ ä¸Šæ–°çš„é‡‘é¢ã€‚â€

> ğŸ§  ç®€å•æ¥è¯´ï¼šâ€œæ›´æ–°è¿™ä¸ªç”¨æˆ·çš„é“¶è¡Œä½™é¢ã€‚â€
> 

### **3. å‘é€äº‹ä»¶**

æœ€åï¼Œæˆ‘ä»¬è®©ä¸–ç•ŒçŸ¥é“åˆšåˆšå‘ç”Ÿäº†ä»€ä¹ˆï¼š

```solidity
emit Deposit(msg.sender, msg.value);

```

è¿™ä¼šè§¦å‘å­˜æ¬¾äº‹ä»¶ï¼Œå‰ç«¯åº”ç”¨æˆ–ç´¢å¼•å™¨å¯ä»¥ç›‘å¬è¯¥äº‹ä»¶ã€‚è¿™å°±åƒåˆçº¦åœ¨å–Šï¼š

> â€œå˜¿ï¼Alice åˆšåˆšå­˜å…¥äº† 1 ETHï¼â€
> 

è¿™å°±æ˜¯å¦‚ä½•ç¡®ä¿ UI æ›´æ–°å¹¶åœ¨ Etherscan ç­‰å·¥å…·ä¸­è®°å½•äº¤æ˜“çš„æ–¹å¼ã€‚

### **ğŸ’¸ withdraw(uint256 amount) â€“ å–å›ä½ çš„èµ„é‡‘**

```solidity
function withdraw(uint256 amount) external {
    require(amount > 0, "Must withdraw a positive amount");
    require(depositBalances[msg.sender] >= amount, "Insufficient balance");

    depositBalances[msg.sender] -= amount;
    payable(msg.sender).transfer(amount);

    emit Withdraw(msg.sender, amount);
}

```

æ—¢ç„¶ç”¨æˆ·å¯ä»¥å­˜å…¥ ETHï¼Œæˆ‘ä»¬éœ€è¦ç»™ä»–ä»¬ä¸€ä¸ªæ–¹å¼æ¥å–å›ä»–ä»¬çš„ ETHâ€”â€”æ— è®ºä½•æ—¶ä»–ä»¬éœ€è¦ã€‚

è¿™æ­£æ˜¯ withdraw()å‡½æ•°çš„ä½œç”¨ã€‚

è®©æˆ‘ä»¬åƒä¸€ä½èµ°è¿›é“¶è¡Œå¹¶è¯´...

â€œå˜¿ï¼Œæˆ‘æƒ³å–å‡ºä¸€äº›æˆ‘çš„èµ„é‡‘ã€‚â€

### **1. âœ… éªŒè¯ææ¬¾è¯·æ±‚**

é¦–å…ˆï¼Œåˆçº¦è¿›è¡Œä¸¤é¡¹å¿«é€Ÿåˆç†æ€§æ£€æŸ¥ï¼š

```solidity
require(amount > 0, "Must withdraw a positive amount");

```

è¿™ç¡®ä¿ç”¨æˆ·ä¸ä¼šä¸å°å¿ƒå°è¯•æå– 0 ETHã€‚æ²¡æœ‰å¥‡æ€ªçš„è¾¹ç¼˜æƒ…å†µï¼Œæ²¡æœ‰å›°æƒ‘â€”â€”åªæ˜¯å¹²å‡€çš„è¾“å…¥ã€‚

```solidity
require(depositBalances[msg.sender] >= amount, "Insufficient balance");

```

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰è¶³å¤Ÿçš„ ETH åœ¨å…¶å­˜æ¬¾ä½™é¢ä¸­æ¥è¿›è¡Œæ­¤æ¬¡ææ¬¾ã€‚

å¦‚æœä¸æ˜¯ï¼Œäº¤æ˜“å°†è¢«æ‹’ç»ã€‚

DeFi ä¸å…è®¸é€æ”¯ ğŸ˜‰

### **2. ğŸ§® æ›´æ–°ä½™é¢**

å¦‚æœä¸¤ä¸ªæ£€æŸ¥éƒ½é€šè¿‡ï¼Œç”¨æˆ·çš„å­˜æ¬¾ä½™é¢å°†å¾—åˆ°æ›´æ–°ï¼š

```solidity
depositBalances[msg.sender] -= amount;

```

è¿™ä»ä»–ä»¬çš„è´¦æˆ·ä¸­æ‰£é™¤æå–çš„é‡‘é¢ã€‚

å°±åƒé“¶è¡Œè´¦æœ¬åæ˜ å·²ç»å‘ç”Ÿäº†ææ¬¾ä¸€æ ·ã€‚

### **3. ğŸª™ å‘é€ ETH**

æ›´æ–°ä½™é¢åï¼Œåˆçº¦å°† ETH å‘é€å›ç”¨æˆ·ï¼š

```solidity
payable(msg.sender).transfer(amount);

```

è¿™ä¸€è¡Œå®é™…ä¸Šå°†çœŸå®çš„ ETH è½¬å›ç”¨æˆ·çš„é’±åŒ…ã€‚

> ğŸ’¡ Solidity è¦æ±‚å¯¹å¯æ”¯ä»˜åœ°å€è°ƒç”¨ .transfer() â€”â€” è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬å°† msg.sender å¼ºåˆ¶è½¬æ¢ä¸º payable(msg.sender)ã€‚
> 

### **4. ğŸ“£ å‘å¸ƒäº‹ä»¶**

æœ€åï¼Œæˆ‘ä»¬è®©å¤§å®¶çŸ¥é“åˆšæ‰å‘ç”Ÿäº†ä»€ä¹ˆï¼š

```solidity
emit Withdraw(msg.sender, amount);

```

è¿™ä¼šè§¦å‘ææ¬¾äº‹ä»¶â€”â€”ä¸€ä¸ªä½ çš„å‰ç«¯å¯ä»¥ç›‘å¬ä»¥æ˜¾ç¤ºç±»ä¼¼ç¡®è®¤æ¶ˆæ¯çš„ä¿¡å·ï¼š

> â€œâœ… æˆåŠŸææ¬¾ 0.5 ETHï¼â€
> 

### **ğŸ§® calculateInterestAccrued(address user) â€“ å€Ÿæ¬¾çš„æ ¸å¿ƒ**

```solidity
function calculateInterestAccrued(address user) public view returns (uint256) {
    if (borrowBalances[user] == 0) {
        return 0;
    }

    uint256 timeElapsed = block.timestamp - lastInterestAccrualTimestamp[user];
    uint256 interest = (borrowBalances[user] * interestRateBasisPoints * timeElapsed) / (10000 * 365 days);

    return borrowBalances[user] + interest;
}

```

è¿™ä¸ªå‡½æ•°æ˜¯æˆ‘ä»¬å€Ÿè´·ç³»ç»Ÿçš„æ ¸å¿ƒå¼•æ“â€”â€”åœ¨å®‰é™åœ°é©±åŠ¨ç€å€Ÿæ¬¾æœ€é‡è¦çš„éƒ¨åˆ†ï¼šåˆ©æ¯è®¡ç®—ã€‚

çŒœçŒœçœ‹ï¼Ÿ

ä½ å°†åœ¨å‡ ä¹æ‰€æœ‰æ¶‰åŠè´·æ¬¾çš„ä¸»è¦åŠŸèƒ½ä¸­çœ‹åˆ°è¿™ä¸ªå‡½æ•°å‡ºç°ï¼š

- âœ… å½“ä½ å€Ÿå…¥
- ğŸ’³ å½“ä½ å¿è¿˜
- ğŸ”“ å½“ä½ æå–æŠµæŠ¼å“
- ğŸ“Š å³ä½¿åœ¨æŸ¥è¯¢ä½ æ¬ å¤šå°‘æ—¶

è®©æˆ‘ä»¬äº†è§£å®ƒå…·ä½“åœ¨åšä»€ä¹ˆâ€”â€”ä»¥åŠä¸ºä»€ä¹ˆè¿™å¦‚æ­¤é‡è¦ã€‚

### **ğŸ“Š æˆ‘ä»¬ä¸ºä»€ä¹ˆéœ€è¦è¿™ä¸ªï¼Ÿ**

åœ¨ç°å®ç”Ÿæ´»ä¸­ï¼Œè´·æ¬¾åˆ©æ¯ä¼šéšç€æ—¶é—´çš„æ¨ç§»è€Œç´¯ç§¯ã€‚

ä½†æ™ºèƒ½åˆçº¦æ— æ³•æ¯ç§’æ›´æ–°å˜é‡â€”â€”é‚£åœ¨ gas è´¹ç”¨ä¸Šä¼šéå¸¸æ˜‚è´µã€‚

æ‰€ä»¥ï¼Œæˆ‘ä»¬ä¸æ˜¯æŒç»­æ›´æ–°æ¯ä¸ªç”¨æˆ·çš„è´·æ¬¾ä½™é¢...

æˆ‘ä»¬ä½¿ç”¨è¿™ä¸ªå‡½æ•°æŒ‰éœ€è®¡ç®—åˆ©æ¯â€”â€”åªåœ¨éœ€è¦æ—¶è®¡ç®—ã€‚

å°†å…¶è§†ä¸ºä¸€ä¸ªå³æ—¶åˆ©æ¯è®¡ç®—å™¨ã€‚

### **âœ… å·¥ä½œåŸç†**

**1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å€Ÿè¿‡ä»»ä½•æ¬¾é¡¹**

```solidity
if (borrowBalances[user] == 0) {
    return 0;
}

```

æ²¡æœ‰è´·æ¬¾ï¼Ÿæ²¡æœ‰åˆ©æ¯ã€‚ç®€å•ã€‚

**2. è®¡ç®—å·²è¿‡å»å¤šå°‘æ—¶é—´**

```solidity
uint256 timeElapsed = block.timestamp - lastInterestAccrualTimestamp[user];

```

æˆ‘ä»¬è®¡ç®—å‡ºè‡ªä¸Šæ¬¡ä¸ºè¯¥ç”¨æˆ·è®¡ç®—åˆ©æ¯ä»¥æ¥å·²è¿‡å»å¤šå°‘æ—¶é—´ã€‚

> block.timestamp ç»™æˆ‘ä»¬å½“å‰çš„æ—¶é—´ã€‚
> 

> lastInterestAccrualTimestamp å‘Šè¯‰æˆ‘ä»¬ä¸Šæ¬¡æ›´æ–°ä»–ä»¬å€ºåŠ¡çš„æ—¶é—´ã€‚
> 

**3. åº”ç”¨åˆ©æ¯å…¬å¼**

```solidity
uint256 interest = (borrowBalances[user] * interestRateBasisPoints * timeElapsed) / (10000 * 365 days);

```

è®©æˆ‘ä»¬æ¥åˆ†è§£è¿™ä¸ªå…¬å¼ï¼š

**borrowBalances[user]**Â â†’ ç”¨æˆ·çš„å½“å‰è´·æ¬¾æœ¬é‡‘

**interestRateBasisPoints**Â â†’ æˆ‘ä»¬çš„å¹´åˆ©ç‡ï¼ˆä¾‹å¦‚ï¼Œ500 ç­‰äº 5%ï¼‰

**timeElapsed**Â â†’ ä»–ä»¬æ¬ å€ºçš„æ—¶é—´é•¿åº¦

**10000 * 365 days**Â â†’ ç”¨äºå°†åŸºå‡†ç‚¹è½¬æ¢ä¸ºå¹´åº¦åˆ†æ•°

è¿™æ ¹æ®è´·æ¬¾çš„æ´»è·ƒæ—¶é—´ï¼Œç»™å‡ºäº†æˆ‘ä»¬åˆ°ç›®å‰ä¸ºæ­¢äº§ç”Ÿçš„åˆ©æ¯ã€‚

### **4. è¿”å›æ€»å€ºåŠ¡ï¼ˆæœ¬é‡‘+åˆ©æ¯ï¼‰**

```solidity
return borrowBalances[user] + interest;

```

å¥½äº†ã€‚å°±è¿™æ ·ï¼Œä½ å°±èƒ½è·å¾—æœ€æ–°çš„å€ºåŠ¡ä¿¡æ¯â€”â€”æ— éœ€æ‰‹åŠ¨è®¡ç®—ã€‚

> è¿™ä¸ªæ€»é¢å°†ç”¨äºæˆ‘ä»¬æ‰€æœ‰å…¶ä»–åŠŸèƒ½ï¼šéªŒè¯å€Ÿæ¬¾èµ„æ ¼ã€æ£€æŸ¥è¿˜æ¬¾é‡‘é¢ä»¥åŠéªŒè¯æŠµæŠ¼å“æå–ã€‚
> 

## **ğŸ›¡ï¸ depositCollateral() â€“ é”å®š ETH ä»¥ä¾¿æ—¥åå€Ÿæ¬¾**

```solidity
function depositCollateral() external payable {
    require(msg.value > 0, "Must deposit a positive amount as collateral");

    collateralBalances[msg.sender] += msg.value;

    emit CollateralDeposited(msg.sender, msg.value);
}

```

åˆ°ç›®å‰ä¸ºæ­¢ï¼Œä½ å·²ç»çœ‹åˆ°äº†å¦‚ä½•å°† ETH å­˜å…¥æ± ä¸­ä½œä¸ºå‡ºå€Ÿäººâ€”â€”å¦‚æœä½ æƒ³èµšå–è¢«åŠ¨æ”¶å…¥ï¼Œè¿™å¾ˆå¥½ã€‚

ä½†å¦‚æœä½ æƒ³ä»æ± ä¸­å€Ÿæ¬¾å‘¢ï¼Ÿ

å—¯ï¼Œå°±åƒç°å®ç”Ÿæ´»ä¸­ä¸€æ ·â€”â€”å¦‚æœä½ æƒ³è´·æ¬¾ï¼Œéœ€è¦æä¾›æŠµæŠ¼å“ã€‚

è¿™ä¸ªå‡½æ•°å°±æ˜¯ç”¨æ¥å®Œæˆè¿™ä¸ªæ“ä½œçš„ã€‚

æˆ‘ä»¬æ¥åˆ†è§£ä¸€ä¸‹ ğŸ‘‡

### **ğŸ”’ æŠµæŠ¼å“ä¸å­˜æ¬¾â€”â€”æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ**

åœ¨æ·±å…¥ä»£ç ä¹‹å‰ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªå…³é”®çš„åŒºåˆ«ï¼š

| DepositsÂ Â å­˜æ¬¾ | æŠµæŠ¼å“ |
| --- | --- |
| ä½ å€Ÿç»™æ± å­çš„é’± ğŸ’¸ | ä½ ç”¨æ¥å€Ÿé’±çš„é”é’± ğŸ’³ |
| å¯ä»¥è‡ªç”±æå–ï¼ˆé™¤éç”¨äºå€Ÿè´·ï¼‰ | ä»…å½“æ‚¨çš„è´·æ¬¾å®‰å…¨æ—¶æ‰å¯å½’è¿˜ |
| æ‚¨å¯ä»ä¸­èµšå–åˆ©æ¯ï¼ˆå¦‚æœç³»ç»Ÿæ”¯æŒè¯¥åŠŸèƒ½ï¼‰ | å®ƒæ”¯æŒæ‚¨çš„å€Ÿè´·å¹¶ä¿éšœåè®®å®‰å…¨ |

æ‰€ä»¥æ˜¯çš„â€”â€”å®ƒä»¬éƒ½æ˜¯ ETHï¼Œä½†å®ƒä»¬æ‰®æ¼”ç€å®Œå…¨ä¸åŒçš„è§’è‰²ã€‚

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬æœ‰ä¸€ä¸ªå•ç‹¬çš„å‡½æ•°ç”¨äºæŠµæŠ¼å“å­˜æ¬¾ã€‚

### **âœ… æ­¥éª¤è¯¦è§£**

### **1. æ£€æŸ¥çœŸå®å­˜æ¬¾**

```solidity
require(msg.value > 0, "Must deposit a positive amount as collateral");

```

æˆ‘ä»¬ç¡®ä¿ç”¨æˆ·æ­£åœ¨å‘é€ä¸€äº› ETHâ€”â€”ä¸å…è®¸ç©ºäº¤æ˜“ã€‚

**2. å¢åŠ ç”¨æˆ·çš„æŠµæŠ¼å“ä½™é¢**

```solidity
collateralBalances[msg.sender] += msg.value;

```

ä¸€æ—¦æ”¶åˆ° ETHï¼Œæˆ‘ä»¬æ›´æ–°ç”¨æˆ·çš„æŠµæŠ¼è®°å½•ã€‚è¿™å‘Šè¯‰åˆçº¦ï¼š

â€œå¥½äº†ï¼Œè¿™ä½ç”¨æˆ·ç°åœ¨å·²ç»é”å®šäº† X ETHâ€”â€”æˆ‘ä»¬å¯ä»¥è®©ä»–ä»¬åœ¨æŸä¸ªé™é¢å†…å®‰å…¨åœ°å€Ÿæ¬¾ã€‚â€

è¿™æ˜¯ç³»ç»Ÿä¸­è§£é”å€Ÿè´·èƒ½åŠ›çš„å…³é”®ã€‚

**3. å‘å‡ºäº‹ä»¶**

```solidity
emit CollateralDeposited(msg.sender, msg.value);

```

ä¸€å¦‚æ—¢å¾€ï¼Œæˆ‘ä»¬å‘å‡ºäº‹ä»¶ï¼Œä»¥ä¾¿å‰ç«¯å’Œå·¥å…·èƒ½å¤Ÿå¯¹å­˜æ¬¾åšå‡ºååº”â€”â€”æ›´æ–°ä»ªè¡¨æ¿ã€å‘é€é€šçŸ¥ï¼Œå¹¶å°†æ“ä½œè®°å½•åœ¨å†å²ä¸­ã€‚

## **ğŸ”“ withdrawCollateral(uint256 amount) â€“ æ‹¿å›ä½ é”å®šçš„ ETHï¼ˆå¦‚æœä½ æ˜¯å®‰å…¨çš„ï¼‰**

```solidity
function withdrawCollateral(uint256 amount) external {
    require(amount > 0, "Must withdraw a positive amount");
    require(collateralBalances[msg.sender] >= amount, "Insufficient collateral");

    uint256 borrowedAmount = calculateInterestAccrued(msg.sender);
    uint256 requiredCollateral = (borrowedAmount * 10000) / collateralFactorBasisPoints;

    require(
        collateralBalances[msg.sender] - amount >= requiredCollateral,
        "Withdrawal would break collateral ratio"
    );

    collateralBalances[msg.sender] -= amount;
    payable(msg.sender).transfer(amount);

    emit CollateralWithdrawn(msg.sender, amount);
}

```

æ‰€ä»¥ä½ è´¨æŠ¼äº†ä¸€äº› ETH ä½œä¸ºæŠµæŠ¼ã€‚è¿™è®©ä½ è·å¾—äº†ä»æ± ä¸­å€Ÿå…¥èµ„é‡‘çš„æƒåˆ©ã€‚

ç°åœ¨ä½ æƒ³æ‹¿å›ä¸€äº› ETHã€‚

è¿™çœ‹èµ·æ¥å¾ˆå…¬å¹³ï¼Œå¯¹å§ï¼Ÿ

å—¯â€¦â€¦åªæœ‰å½“ä½ ä»ç„¶å®‰å…¨æ—¶æ‰è¡Œã€‚

è¿™ä¸ªåŠŸèƒ½å…è®¸ç”¨æˆ·æå–ä»–ä»¬çš„æŠµæŠ¼å“â€”â€”ä½†å‰ææ˜¯è¿™æ ·åšä¸ä¼šè®©ä»–ä»¬çš„è´·æ¬¾å¤„äºé£é™©ä¹‹ä¸­ã€‚

è®©æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥ï¼Œå°±åƒä½ æ­£åœ¨ä¸ä¸€ä¸ªéå¸¸è°¨æ…ä½†éå¸¸å…¬å¹³çš„æ™ºèƒ½åˆçº¦é“¶è¡Œå®¶è°ˆåˆ¤ä¸€æ ·ã€‚

### **âœ… ç¬¬ä¸€æ­¥ï¼šåŸºæœ¬æ£€æŸ¥**

```solidity
require(amount > 0, "Must withdraw a positive amount");
require(collateralBalances[msg.sender] >= amount, "Insufficient collateral");

```

è¿™ä¸¤è¡Œä»£ç å¾ˆç›´æ¥ï¼š

ç¡®ä¿ç”¨æˆ·æ­£åœ¨å°è¯•æå–ä¸€ä¸ªçœŸå®çš„é‡‘é¢ã€‚

ç¡®ä¿ä»–ä»¬ç¡®å®æœ‰è¶³å¤Ÿçš„æŠµæŠ¼å“æ¥å°è¯•è¿™ä¸€ç‚¹ã€‚

å¦‚æœä»»ä½•ä¸€é¡¹æ£€æŸ¥å¤±è´¥â€”â€”æˆ‘ä»¬ç«‹å³åœæ­¢ã€‚

### **ğŸ§  ç¬¬ 2 æ­¥ï¼šé£é™©è¯„ä¼°**

ç°åœ¨è¿›å…¥é‡è¦ç¯èŠ‚â€”â€”ç¡®ä¿ç”¨æˆ·åœ¨ææ¬¾åä»ç„¶æœ‰æŠµæŠ¼å“ã€‚

### **é¦–å…ˆï¼Œæˆ‘ä»¬æ£€æŸ¥ä»–ä»¬æ¬ å¤šå°‘å€ºåŠ¡ï¼š**

```solidity
uint256 borrowedAmount = calculateInterestAccrued(msg.sender);

```

è¿™åŒ…æ‹¬ä»–ä»¬éšæ—¶é—´ç´¯ç§¯çš„ä»»ä½•åˆ©æ¯ã€‚

### **ç„¶åæˆ‘ä»¬è®¡ç®—ä»–ä»¬éœ€è¦å¤šå°‘æŠµæŠ¼å“æ‰èƒ½ä¿æŒå®‰å…¨ï¼š**

```solidity
uint256 requiredCollateral = (borrowedAmount * 10000) / collateralFactorBasisPoints;

```

è¿™æ˜¯åŸºäºæˆ‘ä»¬ä¹‹å‰è®¾ç½®çš„è´·æ¬¾ä»·å€¼æ¯”ï¼ˆLTVï¼‰â€”â€” é»˜è®¤ä¸º 75%ã€‚

å‡è®¾ä½ æ¬  1 ETHï¼ŒLTV ä¸º 75%ï¼š

ä½ éœ€è¦è‡³å°‘ 1 / 0.75 = 1.33 ETH ä½œä¸ºæŠµæŠ¼å“é”å®šã€‚

### **â— ç¬¬ 3 æ­¥ï¼šå®‰å…¨æ£€æŸ¥**

æˆ‘ä»¬ç°åœ¨æ¨¡æ‹Ÿæœªæ¥â€”â€”å¦‚æœä½ æŠµæŠ¼äº†è¿™ç¬”èµ„äº§ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ

```solidity
require(
    collateralBalances[msg.sender] - amount >= requiredCollateral,
    "Withdrawal would break collateral ratio"
);

```

å¦‚æœç§»é™¤è¯¥ ETH ä¼šå¯¼è‡´ä½ ä½äºå®‰å…¨é™åˆ¶ï¼Œæˆ‘ä»¬å°†å›æ»šäº¤æ˜“ã€‚

> âš ï¸ è¿™å°±åƒåˆçº¦å‘å‡ºçš„è­¦å‘Šï¼šâ€œç­‰ä¸€ä¸‹ã€‚å¦‚æœä½ è¿™æ ·åšï¼Œä½ çš„è´·æ¬¾å°†ä¸å†å¾—åˆ°ä¿éšœã€‚æˆ‘ä¸èƒ½å…è®¸é‚£æ ·ã€‚â€
> 

### **ğŸª™ ç¬¬ 4 æ­¥ï¼šæ”¾æ‰‹ï¼ˆå¦‚æœä½ å®‰å…¨ï¼‰**

å¦‚æœä½ é€šè¿‡æ‰€æœ‰æ£€æŸ¥ï¼Œä½ å°±å¯ä»¥ç»§ç»­ã€‚

```solidity
collateralBalances[msg.sender] -= amount;
payable(msg.sender).transfer(amount);
emit CollateralWithdrawn(msg.sender, amount);

```

æˆ‘ä»¬æ›´æ–°ä½ çš„è®°å½•ï¼Œå°† ETH å‘å›ä½ çš„é’±åŒ…ï¼Œå¹¶å‘å‡ºä¸€ä¸ªäº‹ä»¶é€šçŸ¥å‰ç«¯ã€‚

## **ğŸ§¾ borrow(uint256 amount) â€“ è§£é” DeFi çš„è¶…çº§èƒ½åŠ›ï¼šå€Ÿå…¥ ETH**

```solidity

function borrow(uint256 amount) external {
    require(amount > 0, "Must borrow a positive amount");
    require(address(this).balance >= amount, "Not enough liquidity in the pool");

    uint256 maxBorrowAmount = (collateralBalances[msg.sender] * collateralFactorBasisPoints) / 10000;
    uint256 currentDebt = calculateInterestAccrued(msg.sender);

    require(currentDebt + amount <= maxBorrowAmount, "Exceeds allowed borrow amount");

    borrowBalances[msg.sender] = currentDebt + amount;
    lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

    payable(msg.sender).transfer(amount);
    emit Borrow(msg.sender, amount);
}

```

å¥½å§â€”â€”ç°åœ¨æˆ‘ä»¬è¿›å…¥åˆåŒçœŸæ­£å¼€å§‹åƒé“¶è¡Œè¿ä½œçš„éƒ¨åˆ†ã€‚

è¿™ä¸ªåŠŸèƒ½å…è®¸ç”¨æˆ·ä»å€Ÿè´·æ± ä¸­å€Ÿå…¥ ETHï¼ŒåŸºäºä»–ä»¬é”å®šçš„æŠµæŠ¼å“æ•°é‡ã€‚

ä½†æ˜¯â€”â€”å°±åƒç°å®ç”Ÿæ´»ä¸­ä¸€æ ·â€”â€”ä½ ä¸èƒ½èµ°è¿›é“¶è¡Œè¯´â€œç»™æˆ‘å…è´¹çš„é’±ã€‚â€

æœ‰è§„åˆ™ã€‚è®©æˆ‘ä»¬æ¥é€ä¸€äº†è§£å®ƒä»¬ã€‚

### **ğŸ§  æ­¥éª¤è¯¦è§£**

**1. ç”³è¯·çœŸå®è´·æ¬¾**

```solidity
require(amount > 0, "Must borrow a positive amount");

```

æˆ‘ä»¬ç¡®ä¿ç”¨æˆ·ä¸æ˜¯è¯•å›¾å€Ÿå…¥é›¶ ETH æˆ–è´Ÿæ•°é‡‘é¢ã€‚æ¯æ¬¡å€Ÿæ¬¾æ“ä½œéƒ½å¿…é¡»æœ‰ä¸€ä¸ªå®é™…æ•°å­—ä½œä¸ºæ”¯æ’‘ã€‚

**2. ç¡®ä¿æ± ä¸­æœ‰æµåŠ¨æ€§**

```solidity
require(address(this).balance >= amount, "Not enough liquidity in the pool");

```

è¯¥åˆçº¦æ£€æŸ¥è‡ªèº«ä½™é¢ï¼Œä»¥ç¡®è®¤æ˜¯å¦çœŸçš„èƒ½å¤Ÿå€Ÿå‡ºé‚£ä¹ˆå¤š ETHã€‚

> ä¸èƒ½å€Ÿè´·è‡ªå·±æ²¡æœ‰çš„èµ„äº§ã€‚
> 

### **3. æ£€æŸ¥å€Ÿæ¬¾äººèµ„æ ¼**

æˆ‘ä»¬æ ¹æ®ç”¨æˆ·æä¾›çš„æŠµæŠ¼å“æ•°é‡ï¼Œè®¡ç®—å…¶å¯å€Ÿæ¬¾é‡‘é¢ï¼š

```solidity
uint256 maxBorrowAmount = (collateralBalances[msg.sender] * collateralFactorBasisPoints) / 10000;

```

æ‰€ä»¥å¦‚æœä½ æŠµæŠ¼äº† 2 ETH ä½œä¸ºä¿è¯é‡‘ï¼Œå¹¶ä¸”ä¿è¯é‡‘ç³»æ•°æ˜¯ 75%ï¼š

- maxBorrowAmount = 2 * 0.75 = 1.5 ETH

ä½†è¿™è¿˜æ²¡å®Œâ€”â€”æˆ‘ä»¬è¿˜éœ€è¦è€ƒè™‘ä»–ä»¬å·²ç»æ¬ ä¸‹çš„ä»»ä½•å€ºåŠ¡+åˆ©æ¯ï¼š

```solidity
uint256 currentDebt = calculateInterestAccrued(msg.sender);

```

ç„¶åæˆ‘ä»¬æ£€æŸ¥ï¼š

```solidity
require(currentDebt + amount <= maxBorrowAmount, "Exceeds allowed borrow amount");

```

å¦‚æœè¿™æ¬¡æ£€æŸ¥å¤±è´¥ï¼Œå€Ÿè´·å°†è¢«é˜»æ­¢ã€‚ç”¨æˆ·çš„æŠµæŠ¼å“æ— æ³•å®‰å…¨åœ°æ”¯æŒè¯·æ±‚çš„é‡‘é¢ã€‚

> âœ… åªå…è®¸å®‰å…¨ã€è¶…é¢æŠµæŠ¼çš„è´·æ¬¾ã€‚
> 

**4. æ›´æ–°å€ºåŠ¡å’Œæ—¶é—´**

å¦‚æœç”¨æˆ·ç¬¦åˆèµ„æ ¼ï¼Œæˆ‘ä»¬å°†ç»§ç»­å¹¶è®°å½•æ–°çš„è´·æ¬¾

```solidity
borrowBalances[msg.sender] = currentDebt + amount;
lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

```

æˆ‘ä»¬è¡¨ç¤ºï¼š

- â€œè¯¥ç”¨æˆ·ç°åœ¨æ¬  X ETHï¼ˆåŒ…æ‹¬è¿‡å»çš„å€ºåŠ¡ï¼‰ã€‚â€
- â€œè€Œè¿™å°†æ˜¯æˆ‘ä»¬æœªæ¥è®¡ç®—åˆ©æ¯çš„æ—¶é—´ã€‚â€

### **5. è½¬ç§» ETH**

```solidity
payable(msg.sender).transfer(amount);

```

åˆçº¦å°†çœŸå®çš„ ETH å‘é€åˆ°ç”¨æˆ·çš„é’±åŒ…ä¸­ã€‚

ç°åœ¨ä»–ä»¬å¯ä»¥éšå¿ƒæ‰€æ¬²åœ°ä½¿ç”¨è¿™äº› ETHâ€”â€”äº¤æ˜“å®ƒã€äº¤æ¢å®ƒã€è´¨æŠ¼å®ƒâ€”â€”å®ƒå®Œå…¨å±äºä»–ä»¬ã€‚

**6. å‘å¸ƒå€Ÿå‡ºäº‹ä»¶**

```solidity
emit Borrow(msg.sender, amount);

```

è¿™å‘å¤–ç•Œï¼ˆä½ çš„å‰ç«¯ã€åŒºå—æµè§ˆå™¨ã€åˆ†æä»ªè¡¨æ¿ï¼‰è¡¨æ˜è¿™ä½ç”¨æˆ·åˆšåˆšå€Ÿäº†æ¬¾ã€‚

## **ğŸ’³ repay() â€“ è¿˜æ¬¾ï¼Œé‡è·è‡ªç”±**

```solidity
function repay() external payable {
    require(msg.value > 0, "Must repay a positive amount");

    uint256 currentDebt = calculateInterestAccrued(msg.sender);
    require(currentDebt > 0, "No debt to repay");

    uint256 amountToRepay = msg.value;
    if (amountToRepay > currentDebt) {
        amountToRepay = currentDebt;
        payable(msg.sender).transfer(msg.value - currentDebt); // Refund the extra
    }

    borrowBalances[msg.sender] = currentDebt - amountToRepay;
    lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

    emit Repay(msg.sender, amountToRepay);
}

```

ä½ å€Ÿäº† ETHã€‚æ—¶é—´æµé€ã€‚åˆ©æ¯ç´¯ç§¯ã€‚

ç°åœ¨è¯¥è¿˜æ¬¾äº†â€”â€”è¿™æ­£æ˜¯è¿™ä¸ªå‡½æ•°çš„ä½œç”¨ã€‚

è®©æˆ‘ä»¬æ¥è§£æå½“ç”¨æˆ·å‘ repay() å‘é€ ETH æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

### **âœ… æ­¥éª¤è¯¦è§£**

**1. ç¡®è®¤ä½ ç¡®å®åœ¨å‘é€ ETH**

```solidity
require(msg.value > 0, "Must repay a positive amount");

```

å°±åƒ deposit() å‡½æ•°ä¸€æ ·ï¼Œæˆ‘ä»¬ä¸æƒ³ç”¨æˆ·è¯¯è§¦è¿™ä¸ªæ“ä½œã€‚ä½ éœ€è¦å®é™…åœ¨å‡½æ•°è°ƒç”¨æ—¶å‘é€ä¸€äº› ETHã€‚

**2. ç¡®è®¤ä½ æ¬ å¤šå°‘**

```solidity
uint256 currentDebt = calculateInterestAccrued(msg.sender);
require(currentDebt > 0, "No debt to repay");

```

è¿™é‡Œæˆ‘ä»¬è¯¢é—®ï¼š

â€œè¿™ä½ç”¨æˆ·æ¬ å¤šå°‘â€”â€”åŒ…æ‹¬ç´¯ç§¯çš„ä»»ä½•åˆ©æ¯ï¼Ÿâ€

å¦‚æœä»–ä»¬ä¸æ¬ ä»»ä½•ä¸œè¥¿ï¼Œæˆ‘ä»¬å°±åˆ°æ­¤ä¸ºæ­¢ã€‚

**3. æ¥å—ä½ å‘é€çš„å†…å®¹**

```solidity
uint256 amountToRepay = msg.value;

```

ç°åœ¨æˆ‘ä»¬è®°å½•ç”¨æˆ·å°è¯•è¿˜æ¬¾çš„é‡‘é¢ã€‚

**4. å¤„ç†è¶…é¢è¿˜æ¬¾ï¼ˆé€€æ¬¾å¤šä½™éƒ¨åˆ†ï¼‰**

```solidity

if (amountToRepay > currentDebt) {
    amountToRepay = currentDebt;
    payable(msg.sender).transfer(msg.value - currentDebt);
}

```

æœ‰æ—¶ç”¨æˆ·è¿˜æ¬¾é‡‘é¢è¶…è¿‡æ¬ æ¬¾ï¼ˆå°¤å…¶æ˜¯ä¸ç¡®å®šå·²äº§ç”Ÿçš„åˆ©æ¯é‡‘é¢æ—¶ï¼‰ã€‚æˆ‘ä»¬ä¼˜é›…åœ°å¤„ç†è¿™ç§æƒ…å†µï¼š

å°†è¿˜æ¬¾é‡‘é¢é™åˆ¶åœ¨å€ºåŠ¡é‡‘é¢å†…

è‡ªåŠ¨é€€è¿˜å¤šä½™çš„ ETH

ğŸ§  æ— éœ€æ‰‹åŠ¨è®¡ç®—å€ºåŠ¡â€”â€”åªéœ€å‘é€è¶³å¤Ÿæˆ–æ›´å¤šçš„ ETHï¼Œåˆçº¦å°†å¤„ç†å…¶ä½™éƒ¨åˆ†ã€‚

**5. æ›´æ–°è´·æ¬¾è®°å½•**

```solidity
borrowBalances[msg.sender] = currentDebt - amountToRepay;
lastInterestAccrualTimestamp[msg.sender] = block.timestamp;

```

è¿™ä¼šå‡å°‘ç”¨æˆ·çš„è´·æ¬¾ä½™é¢å¹¶é‡ç½®åˆ©æ¯ç´¯ç§¯çš„è®¡æ—¶å™¨ã€‚

å¦‚æœä»–ä»¬å…¨é¢è¿˜æ¬¾ï¼Œä»–ä»¬çš„å€Ÿæ¬¾ä½™é¢å˜ä¸ºé›¶â€”â€”æ— å€ºåŠ¡ï¼

### **6. è§¦å‘è¿˜æ¬¾äº‹ä»¶**

```solidity
emit Repay(msg.sender, amountToRepay);

```

å‰ç«¯ã€æµè§ˆå™¨æˆ–åˆ†æå·¥å…·ç°åœ¨å¯ä»¥æ˜¾ç¤ºï¼š

> â€œâœ… 1 ETH çš„è´·æ¬¾å·²è¿˜æ¬¾å®Œæˆï¼â€
> 

## **ğŸ“Š å·¥å…·å‡½æ•°â€”â€”æ”¯æŒ UI ä¸é›†æˆçš„è¾…åŠ©å·¥å…·**

æ™ºèƒ½åˆçº¦ä¸­çš„å¹¶éæ¯ä¸ªå‡½æ•°éƒ½ä¼šæ”¹å˜çŠ¶æ€æˆ–å¤„ç†èµ„é‡‘ã€‚

æœ‰æ—¶ï¼Œä½ åªéœ€è¦æ£€æŸ¥æŸäº›å†…å®¹ã€‚

è¿™æ—¶å·¥å…·å‡½æ•°å°±æ´¾ä¸Šç”¨åœºäº†â€”â€”å®ƒä»¬æ˜¯ç®€å•çš„åªè¯»å·¥å…·ï¼Œå¸®åŠ©å‰ç«¯ã€å…¶ä»–æ™ºèƒ½åˆçº¦æˆ–åˆ†æä»ªè¡¨æ¿ä»åˆçº¦ä¸­è·å–æœ‰ç”¨æ•°æ®ã€‚

åœ¨æˆ‘ä»¬çš„ DeFi é“¶è¡Œä¸­ï¼Œæˆ‘ä»¬æœ‰ä¸¤ä¸ªè¿™æ ·çš„å®ç”¨å‡½æ•°ï¼Œå®ƒä»¬ç¡®å®èƒ½åšåˆ°è¿™ä¸€ç‚¹ï¼š

**ğŸ” getMaxBorrowAmount(address user)**

```solidity
function getMaxBorrowAmount(address user) external view returns (uint256) {
    return (collateralBalances[user] * collateralFactorBasisPoints) / 10000;
}

```

è¿™ä¸ªå‡½æ•°è®¡ç®—ç‰¹å®šç”¨æˆ·æ ¹æ®å…¶å·²æŠµæŠ¼çš„ä¿è¯é‡‘å¯ä»¥å€Ÿå¤šå°‘ ETHã€‚

å®ƒä¸åœ¨ä¹ä»–ä»¬å·²ç»å€Ÿäº†å¤šå°‘â€”â€”å®ƒåªæ˜¯å‘Šè¯‰ä½ ï¼Œåœ¨ä»–ä»¬çš„ä¿è¯é‡‘ä¸‹ï¼Œä»–ä»¬å¯ä»¥å€Ÿçš„ä¸Šé™æ˜¯å¤šå°‘ã€‚

> ğŸ§  å…¬å¼ï¼šmaxBorrow = collateral Ã— collateralFactor
> 

æ‰€ä»¥å¦‚æœæœ‰äººé”å®šäº† 4 ETHï¼Œè€Œæˆ‘ä»¬çš„æŠµæŠ¼ç‡æ˜¯ 75%ï¼Œè¿™ä¸ªå‡½æ•°å°†è¿”å›ï¼š

- 4 Ã— 0.75 = 3 ETH â†’ é‚£å°±æ˜¯ä»–ä»¬çš„æœ€å¤§å¯å€Ÿé¢åº¦

è¿™å¯¹å‰ç«¯å¼€å‘éå¸¸æœ‰ç”¨ï¼š

- å®ƒå…è®¸ç•Œé¢æ˜¾ç¤ºï¼šâ€œä½ å¯ä»¥å€Ÿæœ€å¤š 3 ETHâ€
- æˆ–è€…æ˜¾ç¤ºä¸€ä¸ªè¿›åº¦æ¡ï¼Œå±•ç¤ºä»–ä»¬å·²ä½¿ç”¨çš„å€Ÿæ¬¾é¢åº¦

**ğŸ’§ getTotalLiquidity()**

```solidity
function getTotalLiquidity() external view returns (uint256) {
    return address(this).balance;
}

```

è¿™ä¸ªæ›´ç®€å•â€”â€”å®ƒåªæ˜¯å‘Šè¯‰ä½ å½“å‰å€Ÿè´·æ± æŒæœ‰å¤šå°‘ ETHã€‚

ç”±äºæ¯ä¸€ç¬”å­˜æ¬¾å’Œè¿˜æ¬¾éƒ½ä¼šå‘åˆçº¦æ·»åŠ  ETHï¼Œè€Œæ¯ä¸€ç¬”ææ¬¾æˆ–å€Ÿæ¬¾éƒ½ä¼šç§»é™¤ ETHï¼Œè¿™ä¸ªå‡½æ•°æä¾›äº†å®æ—¶çš„èµ„é‡‘æƒ…å†µã€‚

> è¿™å°±åƒæ£€æŸ¥é“¶è¡Œçš„ä¿é™©åº“ä½™é¢ã€‚
> 

å‰ç«¯å¯ä»¥ä½¿ç”¨è¿™ä¸ªåŠŸèƒ½ï¼š

- æ˜¾ç¤ºæ€»æ± å¤§å°
- æŒ‡ç¤ºæ˜¯å¦æœ‰è¶³å¤Ÿçš„æµåŠ¨æ€§æ¥æ»¡è¶³å€Ÿè´·è¯·æ±‚
- è‹¥èµ„é‡‘æ± ä½™é¢ä¸è¶³ï¼Œè¯·æé†’ç”¨æˆ·

### **ğŸ”š æ€»ç»“â€”â€”ä½ æ‰€æ„å»ºçš„**

ä½ åˆšåˆšåˆ›å»ºäº†ä¸€ä¸ªåŠŸèƒ½å®Œå¤‡çš„èµ„é‡‘æ± ï¼Œå®ƒå¯ä»¥ï¼š

- æ¥å—å­˜æ¬¾ ğŸ’°
- è®©ç”¨æˆ·é”å®šæŠµæŠ¼å“ ğŸ›¡ï¸
- å€Ÿå…¥ ETH ğŸ“¤
- éšæ—¶é—´ç´¯ç§¯åˆ©æ¯ ğŸ“ˆ
- è®©ç”¨æˆ·è¿˜æ¬¾å¹¶å–å›æŠµæŠ¼å“ âœ…

æœ¬åˆåŒå‘æ‚¨ä»‹ç»å»ä¸­å¿ƒåŒ–å€Ÿè´·çš„æ ¸å¿ƒæœºåˆ¶â€”â€”è¿™æ˜¯åƒ Aaveã€Compound å’Œ MakerDAO è¿™æ ·çš„å¹³å°æ‰€ä½¿ç”¨çš„ç›¸åŒåŸåˆ™ã€‚

å®ƒç®€å•è€Œå¼ºå¤§ã€‚